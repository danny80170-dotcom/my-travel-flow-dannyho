<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelFlow AI</title>
    
    <!-- iOS PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TravelFlow">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/826/826070.png">

    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ Babel (ç”¨æ–¼è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Markdown è§£æ (ç”¨æ–¼ AI å›è¦†) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ fixed é–å®š body */
        html { height: 100%; overflow: hidden; }
        body { 
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Inter', sans-serif; 
            background-color: #fffbf0; 
            position: fixed; overflow: hidden; 
            touch-action: pan-y; -webkit-user-select: none; user-select: none;
        }
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
        input, textarea { -webkit-user-select: text; user-select: text; }
        .scrolling-touch { -webkit-overflow-scrolling: touch; }
        h1, h2, h3, .japanese-font { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .btn-sakura { background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%); }
        .petal { position: fixed; top: -10px; background-color: #ffd7e6; border-radius: 100% 0 100% 0; opacity: 0.8; z-index: 0; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { 0% { transform: translate(0, 0) rotate(0deg); opacity: 0; } 10% { opacity: 0.9; } 90% { opacity: 0.5; } 100% { transform: translate(100px, 100vh) rotate(720deg); opacity: 0; } }
        .weather-card-gradient { background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 100%); }
        
        /* Markdown Styles for Chat */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose strong { color: #e11d48; font-weight: 700; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-display" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:9999;padding:20px;color:red;"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-display').innerHTML = `<h3>âš ï¸ Error</h3><p>${message}</p>`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Map, Calendar, Clock, Plus, Trash2, MapPin, Bed, Plane, ChevronLeft, Save, 
            X, Sun, Utensils, Camera, Bus, Copy, Check, Sparkles, Loader2, ListPlus, 
            Lightbulb, CloudSun, Phone, Wallet, Car, Navigation, LayoutGrid, Settings, Key,
            UserCheck, UtensilsCrossed, CloudRain, Image as ImageIcon, Move, Droplets, Cloud, 
            CloudLightning, Wind, MessageCircle, Send, Bot, RefreshCw, ArrowLeft, ArrowRight,
            HelpCircle, Link
        } from 'https://esm.sh/lucide-react@latest?deps=react@18.2.0';

        const apiKey = ""; // Runtime key
        const generateId = () => Date.now() + Math.random();

        // é è¨­è¡Œç¨‹
        const DEFAULT_TRIPS = [
          {
            id: 1715432000000,
            title: "ğŸ‡¯ğŸ‡µ æ²–ç¹©è‡ªé§•æ¼«éŠ",
            startDate: "2025-06-15",
            arrival: { time: "10:00", location: "é‚£éœ¸æ©Ÿå ´ OKA" },
            departure: { time: "17:00", location: "é‚£éœ¸æ©Ÿå ´ OKA" },
            expenses: [], emergencyContacts: [],
            days: [
              {
                id: 1715432000001, date: "Day 1", hotel: "Vessel Hotel Campana", weather: "sunny",
                activities: [
                  { id: 101, time: "10:30", type: "transport", title: "å–è»Šå‡ºç™¼", location: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€", note: "" },
                  { id: 102, time: "12:00", type: "food", title: "å¹¸ç¦é¬†é¤…", location: "å¹¸ç¦é¬†é¤… ç€¨é•·å³¶åº—", note: "éœ€é ç´„" }
                ]
              }
            ]
          }
        ];

        const ACTIVITY_TYPES = {
          sightseeing: { label: "æ™¯é»", icon: Camera, color: "text-rose-700 bg-rose-50 border-rose-200" }, 
          food: { label: "ç¾é£Ÿ", icon: Utensils, color: "text-amber-700 bg-amber-50 border-amber-200" }, 
          transport: { label: "äº¤é€š", icon: Car, color: "text-stone-600 bg-stone-100 border-stone-300" }, 
          accommodation: { label: "ä½å®¿", icon: Bed, color: "text-emerald-700 bg-emerald-50 border-emerald-200" }, 
          shopping: { label: "è³¼ç‰©", icon: MapPin, color: "text-indigo-700 bg-indigo-50 border-indigo-200" }, 
          other: { label: "å…¶ä»–", icon: MapPin, color: "text-gray-600 bg-gray-50 border-gray-200" },
        };

        const calculateDate = (startDate, dayIndex) => {
            if (!startDate) return "";
            try {
                const parts = startDate.split('-');
                if (parts.length !== 3) return ""; 
                const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                d.setDate(d.getDate() + dayIndex); 
                return `${d.getMonth() + 1}/${d.getDate()} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
            } catch (e) { return ""; }
        };

        async function callGemini(prompt, responseMimeType = "application/json") {
          try {
            const userApiKey = localStorage.getItem('travel_flow_api_key');
            const effectiveApiKey = apiKey || userApiKey || "";
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveApiKey}`,
              { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: responseMimeType } }) }
            );
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            return responseMimeType === "application/json" && text ? JSON.parse(text) : text;
          } catch (error) { throw error; }
        }

        // --- MapImportModal (Updated for Google Maps) ---
        function MapImportModal({ isOpen, onClose, onImport, currentTrip }) {
            const [importText, setImportText] = useState("");
            const [parsedDays, setParsedDays] = useState([]); 
            const [importTitle, setImportTitle] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [currentStep, setCurrentStep] = useState(1); 
            const [showHelp, setShowHelp] = useState(false);
            
            useEffect(() => {
                if (isOpen) { setCurrentStep(1); setParsedDays([]); setShowHelp(false); }
            }, [isOpen]);

            const handleAIParseMapList = async () => {
                if (!importText) return;
                setIsLoading(true);
                setParsedDays([]);
                const tripDuration = currentTrip.days.length;
                // Updated Prompt to handle messy Google Maps text
                const prompt = `
                æ‚¨æ˜¯å°ˆæ¥­å°éŠã€‚ä½¿ç”¨è€…æä¾›äº†ä¸€æ®µåŒ…å«å¤šå€‹åœ°é»çš„æ–‡å­—ï¼ˆå¯èƒ½ä¾†è‡ª Google Maps åˆ†äº«æ¸…å–®ï¼ŒåŒ…å«ç¶²å€ã€åœ°å€æˆ–äº‚ç¢¼ï¼‰ã€‚
                è«‹åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š
                1. ä»”ç´°å¾æ–‡å­—ä¸­èƒå–æ‰€æœ‰ã€Œå…·é«”çš„åœ°é»åç¨±ã€ï¼ˆå¿½ç•¥ç¶²å€ã€åœ°å€ã€è©•è«–ï¼‰ã€‚
                2. å°‡é€™äº›åœ°é»ï¼Œæ ¹æ“šåœ°ç†ä½ç½®çš„é †è·¯ç¨‹åº¦ï¼Œåˆ†é…åˆ° ${tripDuration} å¤©çš„è¡Œç¨‹ä¸­ã€‚
                3. è«‹å›å‚³ JSON: { "tripTitle": "...", "days": [{ "dateTitle": "...", "activities": [{ "time": "HH:MM", "title": "åœ°é»åç¨±", "type": "sightseeing/food/shopping", "location": "åœ°é»åç¨±(ç”¨æ–¼å°èˆª)", "note": "ç‰¹è‰²èˆ‡å»ºè­°" }] }] }
                
                ä½¿ç”¨è€…è¼¸å…¥ï¼š
                ${importText}
                `;
                try {
                    const result = await callGemini(prompt);
                    setParsedDays(result.days || []); 
                    setImportTitle(result.tripTitle || currentTrip.title); 
                    setCurrentStep(2);
                } catch (error) { alert("AI è§£æå¤±æ•—: " + error.message); } finally { setIsLoading(false); }
            };
            
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-end md:items-center justify-center z-50 p-0 md:p-4 overflow-y-auto">
                    <div className="bg-white rounded-t-3xl md:rounded-3xl w-full max-w-lg p-6 pb-10 md:pb-6 shadow-2xl h-[85vh] md:h-auto flex flex-col animate-in slide-in-from-bottom duration-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-stone-800 flex items-center gap-2 japanese-font">
                                <ListPlus size={24}/> 
                                {currentStep === 1 ? "æ™ºèƒ½åŒ¯å…¥ / Google Maps" : "ç¢ºèªè¡Œç¨‹å®‰æ’"}
                            </h3>
                            <button onClick={onClose} className="p-2 text-stone-400 hover:bg-stone-100 rounded-full"><X size={20} /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            {currentStep === 1 ? (
                                <div className="space-y-4">
                                    {/* Google Maps Hint */}
                                    <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-sm">
                                        <button onClick={() => setShowHelp(!showHelp)} className="w-full flex justify-between items-center text-indigo-800 font-bold mb-1">
                                            <span className="flex items-center gap-2"><Link size={14}/> å¦‚ä½•åŒ¯å…¥ Google Maps æ¸…å–®ï¼Ÿ</span>
                                            <ChevronLeft size={16} className={`transition-transform ${showHelp ? '-rotate-90' : 'rotate-180'}`}/>
                                        </button>
                                        {showHelp && (
                                            <ol className="list-decimal list-inside text-indigo-600/80 space-y-1 mt-2 text-xs ml-1">
                                                <li>æ‰“é–‹ Google Maps App >ã€Œå·²å„²å­˜ã€</li>
                                                <li>é»æ“Šæ¸…å–®æ—çš„ã€Œ...ã€> é¸æ“‡ã€Œåˆ†äº«æ¸…å–®ã€</li>
                                                <li>é¸æ“‡ã€Œè¤‡è£½åˆ°å‰ªè²¼ç°¿ã€</li>
                                                <li>å°‡è¤‡è£½çš„æ–‡å­—ç›´æ¥è²¼åœ¨ä¸‹æ–¹æ¡†æ¡†</li>
                                            </ol>
                                        )}
                                    </div>

                                    <textarea 
                                        placeholder="åœ¨æ­¤è²¼ä¸Šåœ°é»æ¸…å–® (ä¾‹å¦‚ï¼šæ¸…æ°´å¯ºã€é‡‘é–£å¯º) æˆ– Google Maps åˆ†äº«çš„æ–‡å­—..." 
                                        value={importText} 
                                        onChange={(e) => setImportText(e.target.value)} 
                                        className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl h-56 resize-none focus:ring-2 focus:ring-rose-500 outline-none text-sm leading-relaxed"
                                    ></textarea>
                                    
                                    <button onClick={handleAIParseMapList} disabled={!importText || isLoading} className="w-full py-4 btn-sakura text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 disabled:opacity-50">
                                        {isLoading ? <Loader2 className="animate-spin" /> : "AI æ™ºèƒ½åˆ†æèˆ‡è¦åŠƒ âœ¨"}
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="p-3 bg-green-50 text-green-700 rounded-xl text-sm flex items-center gap-2 border border-green-100"><Check size={16}/> æˆåŠŸè­˜åˆ¥ï¼å·²ç‚ºæ‚¨å®‰æ’é †è·¯è¡Œç¨‹ï¼š</div>
                                    <div className="space-y-3">
                                        {parsedDays.map((day, idx) => (
                                            <div key={idx} className="border border-stone-200 rounded-xl p-4 bg-stone-50/50">
                                                <h4 className="font-bold text-stone-800 mb-2 japanese-font border-b border-stone-200 pb-1">{day.dateTitle || `Day ${idx+1}`}</h4>
                                                <div className="space-y-2">
                                                    {day.activities.map((a,i)=>(
                                                        <div key={i} className="text-sm flex gap-2">
                                                            <span className="text-rose-600 font-mono w-12 font-bold flex-shrink-0">{a.time}</span>
                                                            <span className="truncate text-stone-700">{a.title}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button onClick={() => setCurrentStep(1)} className="flex-1 py-3 bg-white border border-stone-300 text-stone-600 font-bold rounded-xl hover:bg-stone-50 flex items-center justify-center gap-1"><ArrowLeft size={16}/> é‡æ–°ç·¨è¼¯</button>
                                        <button onClick={() => { onImport(parsedDays, importTitle); onClose(); }} className="flex-[2] py-3 btn-sakura text-white font-bold rounded-xl shadow-lg hover:opacity-90">ç¢ºèªåŒ¯å…¥</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- AIChatSidebar ---
        function AIChatSidebar({ isOpen, onClose, currentTrip, onUpdateTrip }) {
            const [messages, setMessages] = useState([{ role: 'assistant', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ—…éŠåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¹«ä½ èª¿æ•´è¡Œç¨‹ã€æ¨è–¦é¤å»³ï¼Œæˆ–æ˜¯è§£ç­”æ—…éŠå•é¡Œã€‚' }]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { if (messagesEndRef.current) messagesEndRef.current.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSend = async () => {
                if (!input.trim() || isLoading) return;
                const userText = input; setMessages(prev => [...prev, { role: 'user', text: userText }]); setInput(""); setIsLoading(true);
                try {
                    const tripContext = currentTrip ? JSON.stringify({
                        title: currentTrip.title,
                        days: currentTrip.days.map((d, i) => ({ index: i, date: d.date, activities: d.activities.map(a => ({ time: a.time, title: a.title, location: a.location })) }))
                    }) : "No trip selected";
                    const prompt = `ä½ æ˜¯ä¸€å€‹æœ‰èƒ½åŠ›ä¿®æ”¹ JSON è³‡æ–™çš„æ—…éŠåŠ©æ‰‹ã€‚Current Trip Data: ${tripContext}. User Request: ${userText}. å¦‚æœæ˜¯æ™®é€šèŠå¤©ï¼Œå›å‚³ JSON: { "type": "chat", "response": "Markdown response" }. å¦‚æœæ˜¯ä¿®æ”¹è¡Œç¨‹ï¼Œå›å‚³ JSON: { "type": "update_day", "dayIndex": 0, "response": "Done", "newActivities": [ { "time": "HH:MM", "title": "...", "type": "...", "location": "...", "note": "..." } ] }`;
                    const result = await callGemini(prompt, "application/json");
                    if (result.type === 'update_day' && currentTrip) {
                        const updatedDays = [...currentTrip.days];
                        if (updatedDays[result.dayIndex]) {
                            updatedDays[result.dayIndex].activities = result.newActivities.map(a => ({...a, id: generateId()}));
                            onUpdateTrip(currentTrip.id, { days: updatedDays });
                            setMessages(prev => [...prev, { role: 'assistant', text: result.response + " âœ…" }]);
                        } else { setMessages(prev => [...prev, { role: 'assistant', text: "æ‰¾ä¸åˆ°è©²å¤©è¡Œç¨‹ã€‚" }]); }
                    } else { setMessages(prev => [...prev, { role: 'assistant', text: result.response || "æ”¶åˆ°ï¼" }]); }
                } catch (error) { setMessages(prev => [...prev, { role: 'assistant', text: "API Error. è«‹ç¨å¾Œå†è©¦ã€‚" }]); } finally { setIsLoading(false); }
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 border-l border-stone-200">
                    <div className="p-4 bg-gradient-to-r from-rose-50 to-orange-50 border-b border-stone-200 flex justify-between items-center flex-none">
                        <div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gradient-to-tr from-rose-400 to-orange-400 flex items-center justify-center text-white"><Sparkles size={16}/></div><h3 className="font-bold text-stone-800 japanese-font">AI éš¨èº«åŠ©æ‰‹</h3></div>
                        <button onClick={onClose} className="p-2 hover:bg-white/50 rounded-full"><X size={20}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50/50">
                        {messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] rounded-2xl p-3 text-sm shadow-sm ${m.role === 'user' ? 'bg-rose-500 text-white rounded-tr-none' : 'bg-white border border-stone-100 text-stone-800 rounded-tl-none prose prose-sm'}`} dangerouslySetInnerHTML={{ __html: m.role === 'assistant' ? marked.parse(m.text) : m.text }}></div></div>))}
                        {isLoading && <div className="flex justify-start"><div className="bg-white border border-stone-100 rounded-2xl p-3 rounded-tl-none flex items-center gap-2 text-stone-400 text-xs"><Loader2 className="animate-spin" size={12}/> æ€è€ƒè¡Œç¨‹ä¸­...</div></div>}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="p-3 border-t border-stone-200 bg-white flex-none pb-safe">
                        <div className="flex gap-2"><input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder="è¼¸å…¥è¨Šæ¯..." className="flex-1 bg-stone-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-rose-500 outline-none" /><button onClick={handleSend} disabled={!input.trim() || isLoading} className="p-3 bg-rose-500 text-white rounded-xl hover:bg-rose-600 disabled:opacity-50"><Send size={18} /></button></div>
                    </div>
                </div>
            );
        }

        // --- Dashboard Weather ---
        function DashboardWeather() {
            const [weather, setWeather] = useState(null);
            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=24.1477&longitude=120.6736&daily=weathercode,temperature_2m_max,precipitation_probability_max&current_weather=true&timezone=Asia%2FTaipei').then(res => res.json()).then(setWeather).catch(e => console.error(e));
            }, []);
            if(!weather) return <div className="mx-4 mb-6 h-32 rounded-3xl bg-stone-200 animate-pulse"></div>;
            return (
                <div className="mx-4 mb-6 rounded-3xl p-6 weather-card-gradient shadow-lg border border-white/40 relative z-10 flex justify-between items-center">
                    <div><h2 className="text-3xl font-bold text-stone-800 japanese-font">{Math.round(weather.current_weather.temperature)}Â°</h2><p className="text-stone-500 text-sm">å°ä¸­å¸‚ Â· {new Date().toLocaleDateString()}</p></div>
                    <div className="flex gap-2 text-xs font-bold text-stone-400">{weather.daily.time.slice(0,4).map((t,i) => (<div key={t} className="flex flex-col items-center"><span>{new Date(t).getDate()}æ—¥</span><span className="text-blue-500">{weather.daily.precipitation_probability_max[i]}%â˜”</span></div>))}</div>
                </div>
            );
        }

        // --- CreateTripWizard ---
        function CreateTripWizard({ isOpen, onClose, onCreate }) {
            const [step, setStep] = useState(1);
            const [data, setData] = useState({ 
                title: "", date: new Date().toISOString().split('T')[0], days: 3, useAI: true,
                arrival: { time: "10:00", location: "æ©Ÿå ´" },
                departure: { time: "16:00", location: "æ©Ÿå ´" },
                hotel: ""
            });
            const [isCreating, setIsCreating] = useState(false);

            useEffect(() => { if (isOpen) { setStep(1); setData(prev => ({ ...prev, title: "", date: new Date().toISOString().split('T')[0], days: 3, useAI: true, hotel: "" })); } }, [isOpen]);

            const handleNext = () => { if (step < 3) setStep(step + 1); else handleSubmit(); };
            const handleBack = () => { if (step > 1) setStep(step - 1); };

            const handleSubmit = async () => {
                setIsCreating(true);
                await onCreate(data);
                setIsCreating(false);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-3xl w-full max-w-sm shadow-xl animate-in zoom-in relative overflow-hidden">
                        <div className="absolute top-0 left-0 h-1 bg-stone-100 w-full"><div className="h-full bg-rose-500 transition-all duration-300" style={{width: `${(step/3)*100}%`}}></div></div>
                        <div className="mb-6 mt-2"><h3 className="text-xl font-bold text-stone-800 japanese-font flex justify-between items-center">{step === 1 ? "åŸºæœ¬è³‡è¨Š" : step === 2 ? "èˆªç­è³‡è¨Š" : "ä½å®¿å®‰æ’"}<span className="text-xs text-stone-400 font-sans">Step {step}/3</span></h3></div>
                        {step === 1 && (
                            <div className="space-y-4 animate-in slide-in-from-right duration-200">
                                <div><label className="text-xs font-bold text-stone-500">æ—…ç¨‹åç¨±</label><input type="text" placeholder="ä¾‹å¦‚ï¼šäº¬éƒ½äº”å¤©å››å¤œ" value={data.title} onChange={e=>setData({...data, title:e.target.value})} className="w-full p-3 bg-stone-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-500" autoFocus /></div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-stone-500">å‡ºç™¼æ—¥æœŸ</label><input type="date" value={data.date} onChange={e=>setData({...data, date:e.target.value})} className="w-full p-3 bg-stone-50 rounded-xl outline-none" /></div>
                                    <div><label className="text-xs font-bold text-stone-500">å¤©æ•¸</label><input type="number" min="1" max="15" value={data.days} onChange={e=>setData({...data, days:parseInt(e.target.value)||1})} className="w-full p-3 bg-stone-50 rounded-xl outline-none" /></div>
                                </div>
                                <div onClick={() => setData({...data, useAI: !data.useAI})} className={`p-3 rounded-xl border flex items-center gap-2 cursor-pointer ${data.useAI ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-stone-200 text-stone-500'}`}><div className={`w-5 h-5 rounded border flex items-center justify-center ${data.useAI ? 'bg-indigo-600 border-indigo-600' : 'bg-white'}`}>{data.useAI && <Check size={14} className="text-white"/>}</div><span className="text-sm font-bold flex items-center gap-1"><Sparkles size={14}/> AI è‡ªå‹•è¦åŠƒ</span></div>
                            </div>
                        )}
                        {step === 2 && (
                            <div className="space-y-4 animate-in slide-in-from-right duration-200">
                                <div className="p-3 bg-blue-50 rounded-xl border border-blue-100"><h4 className="font-bold text-blue-800 text-sm mb-2 flex items-center gap-1"><Plane size={14} className="rotate-90"/> å»ç¨‹è³‡è¨Š (Day 1)</h4><div className="flex gap-2"><input type="time" value={data.arrival.time} onChange={e=>setData({...data, arrival:{...data.arrival, time:e.target.value}})} className="w-24 p-2 bg-white rounded-lg text-sm outline-none" /><input type="text" placeholder="æŠµé”æ©Ÿå ´/åœ°é»" value={data.arrival.location} onChange={e=>setData({...data, arrival:{...data.arrival, location:e.target.value}})} className="flex-1 p-2 bg-white rounded-lg text-sm outline-none" /></div></div>
                                <div className="p-3 bg-orange-50 rounded-xl border border-orange-100"><h4 className="font-bold text-orange-800 text-sm mb-2 flex items-center gap-1"><Plane size={14}/> å›ç¨‹è³‡è¨Š (Day {data.days})</h4><div className="flex gap-2"><input type="time" value={data.departure.time} onChange={e=>setData({...data, departure:{...data.departure, time:e.target.value}})} className="w-24 p-2 bg-white rounded-lg text-sm outline-none" /><input type="text" placeholder="å‡ºç™¼æ©Ÿå ´/åœ°é»" value={data.departure.location} onChange={e=>setData({...data, departure:{...data.departure, location:e.target.value}})} className="flex-1 p-2 bg-white rounded-lg text-sm outline-none" /></div></div>
                            </div>
                        )}
                        {step === 3 && (
                            <div className="space-y-4 animate-in slide-in-from-right duration-200">
                                <p className="text-sm text-stone-500">è¨­å®šä½å®¿åœ°é»ï¼ŒAI å°‡ä»¥é€™è£¡ç‚ºæ¯æ—¥èµ·é»ä¾†å®‰æ’è¡Œç¨‹ã€‚</p>
                                <div><label className="text-xs font-bold text-stone-500">ä½å®¿é£¯åº—/å€åŸŸ</label><input type="text" placeholder="ä¾‹å¦‚ï¼šæ–°å®¿æ ¼æ‹‰æ–¯éº—é£¯åº—" value={data.hotel} onChange={e=>setData({...data, hotel:e.target.value})} className="w-full p-4 bg-stone-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-500 text-lg font-bold" autoFocus /></div>
                            </div>
                        )}
                        <div className="flex justify-between gap-2 mt-8">
                            <button onClick={step === 1 ? onClose : handleBack} className="px-4 py-3 text-stone-400 font-bold hover:bg-stone-50 rounded-xl">{step === 1 ? "å–æ¶ˆ" : "ä¸Šä¸€æ­¥"}</button>
                            <button onClick={handleNext} disabled={!data.title || isCreating} className="flex-1 py-3 btn-sakura text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">{isCreating ? <Loader2 className="animate-spin" /> : step === 3 ? (data.useAI ? "é–‹å§‹ AI è¦åŠƒ" : "å»ºç«‹è¡Œç¨‹") : "ä¸‹ä¸€æ­¥"}{!isCreating && step < 3 && <ArrowRight size={16}/>}</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Main TravelPlanner Component ---
        function TravelPlanner() {
          const [trips, setTrips] = useState(() => JSON.parse(localStorage.getItem('travel_planner_trips')) || DEFAULT_TRIPS);
          const [currentTripId, setCurrentTripId] = useState(null);
          const [currentDayIndex, setCurrentDayIndex] = useState(0);
          const [isChatOpen, setIsChatOpen] = useState(false);
          const [isImportModalOpen, setIsImportModalOpen] = useState(false);
          const [isCreateOpen, setIsCreateOpen] = useState(false);

          useEffect(() => { localStorage.setItem('travel_planner_trips', JSON.stringify(trips)); }, [trips]);

          const currentTrip = trips.find(t => t.id === currentTripId);
          const currentDay = currentTrip ? currentTrip.days[currentDayIndex] : null;

          const handleUpdateTrip = (id, data) => setTrips(trips.map(t => t.id === id ? { ...t, ...data } : t));
          const handleDeleteTrip = (id) => { if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) setTrips(trips.filter(t => t.id !== id)); setCurrentTripId(null); };

          const handleCreateTripSubmit = async (data) => {
              try {
                  let generatedDays = [];
                  if (data.useAI) {
                      const prompt = `è«‹ç‚ºæˆ‘è¦åŠƒã€Œ${data.title}ã€ã€‚å‡ºç™¼æ—¥æœŸï¼š${data.date}ã€‚å¤©æ•¸ï¼š${data.days}å¤©ã€‚
                      é‡è¦é™åˆ¶ï¼š
                      1. Day 1 æŠµé”æ™‚é–“ï¼š${data.arrival.time} æ–¼ ${data.arrival.location}ã€‚
                      2. Day ${data.days} é›¢é–‹æ™‚é–“ï¼š${data.departure.time} æ–¼ ${data.departure.location}ã€‚
                      3. ä½å®¿åœ°é»ï¼š${data.hotel}ï¼Œè«‹ä»¥æ­¤ç‚ºæ¯æ—¥èµ·é»ã€‚
                      è«‹å›å‚³ JSON: { "days": [ { "date": "Day 1", "activities": [ { "time": "10:00", "title": "...", "type": "sightseeing/food", "location": "...", "note": "..." } ] } ] }ã€‚`;
                      const result = await callGemini(prompt);
                      if (result?.days) {
                          generatedDays = result.days.map((d, i) => ({
                              id: generateId(), date: d.date || `Day ${i+1}`, hotel: data.hotel || d.hotel || "", weather: "sunny",
                              activities: (d.activities || []).map(a => ({...a, id: generateId()}))
                          }));
                      }
                  } 
                  if (generatedDays.length === 0) {
                       generatedDays = Array.from({length: data.days}, (_, i) => ({ id: generateId(), date: `Day ${i+1}`, hotel: data.hotel, activities: [] }));
                  }
                  const newTrip = { 
                      id: generateId(), title: data.title, startDate: data.date, 
                      arrival: data.arrival, departure: data.departure, expenses: [], emergencyContacts: [], days: generatedDays
                  };
                  setTrips([...trips, newTrip]); 
              } catch (e) { alert("å»ºç«‹å¤±æ•—: " + e.message); }
          };

          const handleImportMapList = (newTripDays, newTripTitle) => {
              const updatedTrips = trips.map(t => {
                  if (t.id === currentTripId) {
                      return { 
                          ...t, title: newTripTitle,
                          days: newTripDays.map((day, idx) => ({
                              id: generateId(), date: day.dateTitle || `Day ${idx + 1}`,
                              hotel: t.days[idx]?.hotel || "", weather: "sunny",
                              activities: day.activities.map(act => ({ ...act, id: generateId() }))
                          }))
                      };
                  } return t;
              });
              setTrips(updatedTrips); setCurrentDayIndex(0);
          };

          const ActivityItem = ({ activity, onDelete }) => (
            <div className="bg-white rounded-2xl p-4 shadow-sm border border-stone-100 mb-4 flex justify-between relative z-10">
                <div>
                    <div className="flex items-center gap-2 mb-1">
                        <span className="font-mono text-sm font-bold text-stone-400">{activity.time}</span>
                        <span className={`text-[10px] px-2 py-0.5 rounded-full ${ACTIVITY_TYPES[activity.type]?.color}`}>{ACTIVITY_TYPES[activity.type]?.label}</span>
                    </div>
                    <h3 className="font-bold text-stone-800">{activity.title}</h3>
                    {activity.location && <div className="flex items-center gap-1 text-xs text-stone-500 mt-1"><MapPin size={12}/> {activity.location}</div>}
                </div>
                <button onClick={() => onDelete(activity.id)} className="text-stone-300 hover:text-red-400 h-fit"><Trash2 size={16}/></button>
            </div>
          );

          if (!currentTrip) {
              return (
                  <div className="h-[100dvh] w-full p-6 pb-24 overflow-y-auto relative z-10 scrolling-touch">
                      <div className="fixed inset-0 pointer-events-none z-0"><div className="petal" style={{left:'10%', animationDuration:'8s'}}></div><div className="petal" style={{left:'50%', animationDuration:'12s'}}></div></div>
                      <DashboardWeather />
                      <h1 className="text-2xl font-bold text-stone-800 px-4 mb-4 japanese-font flex items-center gap-2"><MapPin className="text-rose-500"/> æˆ‘çš„æ—…ç¨‹</h1>
                      <div className="grid gap-4 px-4 relative z-10">
                          {trips.map(trip => (
                              <div key={trip.id} onClick={() => setCurrentTripId(trip.id)} className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-stone-200 cursor-pointer hover:border-rose-300 transition-all">
                                  <h3 className="font-bold text-lg mb-1 japanese-font">{trip.title}</h3>
                                  <p className="text-sm text-stone-500">{trip.startDate} Â· {trip.days.length} å¤©</p>
                              </div>
                          ))}
                          <button onClick={() => setIsCreateOpen(true)} className="py-4 border-2 border-dashed border-stone-300 text-stone-400 rounded-2xl font-bold hover:border-rose-400 hover:text-rose-500 transition-colors flex items-center justify-center gap-2"><Plus/> å»ºç«‹æ–°æ—…ç¨‹</button>
                      </div>
                      <CreateTripWizard isOpen={isCreateOpen} onClose={() => setIsCreateOpen(false)} onCreate={handleCreateTripSubmit} />
                  </div>
              );
          }

          return (
              <div className="h-[100dvh] w-full flex flex-col font-sans text-stone-800 overflow-hidden relative bg-stone-50">
                  <header className="bg-white/90 backdrop-blur-sm px-4 py-3 border-b border-stone-200 flex justify-between items-center sticky top-0 z-30 shadow-sm flex-none">
                      <div className="flex items-center gap-3">
                          <button onClick={() => setCurrentTripId(null)} className="p-2 hover:bg-stone-50 rounded-full text-stone-500"><ChevronLeft/></button>
                          <div>
                              <h1 className="font-bold text-lg truncate japanese-font">{currentTrip.title}</h1>
                              <span className="text-sm text-stone-500">Day {currentDayIndex + 1} ({calculateDate(currentTrip.startDate, currentDayIndex)})</span>
                          </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setIsImportModalOpen(true)} className="p-2 text-stone-500 hover:bg-stone-100 rounded-full"><ListPlus size={20}/></button>
                        <button onClick={() => setIsChatOpen(true)} className={`p-2 rounded-full transition-colors flex items-center gap-1 ${isChatOpen ? 'bg-indigo-100 text-indigo-600' : 'text-stone-500 hover:bg-stone-100'}`}>
                            <Bot size={20} /> <span className="hidden md:inline text-xs font-bold">AI åŠ©æ‰‹</span>
                        </button>
                      </div>
                  </header>

                  <div className="flex-1 relative flex overflow-hidden z-10 min-h-0">
                      <div className="flex-1 flex flex-col h-full min-w-[320px] min-h-0">
                          {/* Day Tabs */}
                          <div className="flex overflow-x-auto p-2 gap-2 bg-white/50 backdrop-blur-sm border-b border-stone-200 no-scrollbar z-20 shadow-sm flex-none sticky top-0">
                              {currentTrip.days.map((day, idx) => (
                                  <button key={day.id} onClick={() => setCurrentDayIndex(idx)} className={`flex-none px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${currentDayIndex === idx ? 'btn-sakura text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}`}>
                                      Day {idx + 1}
                                  </button>
                              ))}
                          </div>

                          <div className="flex-1 overflow-y-auto scrolling-touch p-4 pb-24 custom-scrollbar relative">
                                <h2 className="text-2xl font-bold mb-4 japanese-font flex items-center gap-2"><span className="text-rose-600">Day {currentDayIndex + 1}</span></h2>
                                <div className="space-y-0">
                                    {(currentDay.activities || []).length === 0 ? <div className="text-center py-12 text-stone-400">å°šç„¡è¡Œç¨‹</div> : 
                                      currentDay.activities.map(act => (
                                          <ActivityItem key={act.id} activity={act} onDelete={(id) => {
                                              const updatedDays = [...currentTrip.days];
                                              updatedDays[currentDayIndex].activities = updatedDays[currentDayIndex].activities.filter(a => a.id !== id);
                                              handleUpdateTrip(currentTrip.id, { days: updatedDays });
                                          }} />
                                      ))
                                    }
                                </div>
                          </div>
                      </div>
                  </div>
                  
                  {!isChatOpen && (
                      <button onClick={() => setIsChatOpen(true)} className="fixed bottom-6 right-6 w-14 h-14 bg-stone-800 text-white rounded-full shadow-xl flex items-center justify-center z-40 hover:scale-105 transition-transform md:hidden">
                          <Sparkles size={24} className="text-yellow-300" />
                      </button>
                  )}

                  <AIChatSidebar isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} currentTrip={currentTrip} onUpdateTrip={handleUpdateTrip} />
                  <MapImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImport={handleImportMapList} currentTrip={currentTrip} />
              </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TravelPlanner />);
    </script>
</body>
</html>


