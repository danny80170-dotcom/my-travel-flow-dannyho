<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelFlow</title>
    
    <!-- iOS PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TravelFlow">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/826/826070.png">

    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ Babel (ç”¨æ–¼è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ fixed é–å®š bodyï¼Œé¿å… iOS ç¶²å€åˆ—è¨ˆç®—éŒ¯èª¤é€ æˆç„¡æ³•æ»‘å‹• */
        html {
            height: 100%;
            overflow: hidden;
        }
        body { 
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif; 
            background-color: #fffbf0; 
            position: fixed; /* å¼·åˆ¶å›ºå®šè¦–çª— */
            overflow: hidden; 
            touch-action: pan-y; /* å…è¨±å‚ç›´æ»‘å‹•ï¼Œä½†ç¦æ­¢ç¸®æ”¾ç­‰å…¶ä»–æ‰‹å‹¢ */
            -webkit-user-select: none; /* é¿å…é•·æŒ‰é¸å–æ–‡å­—å½±éŸ¿ App é«”é©— */
            user-select: none;
        }
        
        #root {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* æ¢å¾©è¼¸å…¥æ¡†çš„æ–‡å­—é¸å–åŠŸèƒ½ */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* iOS æ…£æ€§æ²å‹• */
        .scrolling-touch {
            -webkit-overflow-scrolling: touch;
        }
        
        h1, h2, h3, .japanese-font {
            font-family: 'Noto Serif TC', serif;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        #error-display { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; padding: 20px; color: red; overflow: auto; }

        .btn-sakura { background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%); }
        .text-sakura { color: #e11d48; }

        .petal {
            position: fixed; top: -10px; background-color: #ffd7e6; border-radius: 100% 0 100% 0; opacity: 0.8; z-index: 0; pointer-events: none; animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.9; }
            90% { opacity: 0.5; }
            100% { transform: translate(100px, 100vh) rotate(720deg); opacity: 0; }
        }
        
        .guide-content { animation: expandHeight 0.3s ease-out; }
        @keyframes expandHeight { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .guide-section { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* åœ°åœ–è¦–çª—é™°å½± */
        .map-window-shadow { box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-display"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDisplay = document.getElementById('error-display');
            errorDisplay.style.display = 'block';
            errorDisplay.innerHTML = `<h3>âš ï¸ æ‡‰ç”¨ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</h3><p>${message}</p><pre>${error ? error.stack : ''}</pre>`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        
        import { 
            Map, Calendar, Clock, Plus, Trash2, MapPin, 
            Coffee, Bed, Plane, ChevronLeft, Save, 
            MoreVertical, X, Sun, Moon, Utensils, Camera, Bus,
            Share, Copy, ExternalLink, Check, Sparkles, Loader2, Wand2,
            Download, Smartphone, Pencil, ListPlus, Clock3, Lightbulb,
            CloudSun, Phone, Wallet, Car, Navigation,
            LayoutGrid, Menu, PanelRightOpen, PanelRightClose, Settings, Key,
            Flower2, Trees, UserCheck, UtensilsCrossed, CloudRain, Image as ImageIcon, Move
        } from 'https://esm.sh/lucide-react@latest?deps=react@18.2.0';

        const apiKey = "";

        const generateId = () => Date.now() + Math.random();

        // é è¨­è¡Œç¨‹
        const DEFAULT_TRIPS = [
          {
            id: 1715432000000,
            title: "ğŸ‡¯ğŸ‡µ æ²–ç¹©è‡ªé§•æ¼«éŠ",
            startDate: "2024-06-15",
            arrival: { time: "10:00", location: "é‚£éœ¸æ©Ÿå ´ OKA" },
            departure: { time: "17:00", location: "é‚£éœ¸æ©Ÿå ´ OKA" },
            expenses: [
              { id: 1, title: "ç§Ÿè»Šè²»ç”¨", amount: 15000, currency: "JPY" },
              { id: 2, title: "ç¬¬ä¸€å¤©æ™šé¤", amount: 5000, currency: "JPY" }
            ],
            emergencyContacts: [
              { id: 1, name: "ç§Ÿè»Šå…¬å¸ (OTS)", phone: "098-856-8877" },
              { id: 2, name: "è‡ºåŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•", phone: "+81-3-3280-7811" }
            ],
            days: [
              {
                id: 1715432000001,
                date: "Day 1",
                hotel: "Vessel Hotel Campana Okinawa", 
                weather: "sunny",
                activities: [
                  { id: 101, time: "10:30", type: "transport", title: "å–è»Šå‡ºç™¼", note: "é ç´„ä»£è™Ÿ: #OTS-9988ï¼Œè¨˜å¾—æª¢æŸ¥è»Šæ³", location: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€" },
                  { id: 102, time: "12:00", type: "food", title: "å¹¸ç¦é¬†é¤…", note: "å¿…åƒç¾é£Ÿï¼šèˆ’èŠ™è•¾é¬†é¤…ï¼Œéœ€æå‰å…©é€±é ç´„", location: "å¹¸ç¦é¬†é¤… ç€¨é•·å³¶åº—" },
                  { id: 103, time: "14:30", type: "sightseeing", title: "ç¾åœ‹æ‘é€›è¡—", note: "å¿…è²·ä¼´æ‰‹ç¦®ï¼šBlue Seal å†°æ·‡æ·‹å‘¨é‚Š", location: "ç¾åœ‹æ‘" },
                ]
              },
              {
                id: 1715432000002,
                date: "Day 2",
                hotel: "Orion Motobu Resort",
                weather: "cloudy",
                activities: [
                  { id: 201, time: "09:30", type: "sightseeing", title: "ç¾éº—æµ·æ°´æ—é¤¨", note: "å¿…çœ‹ï¼šé»‘æ½®ä¹‹æµ·é¤µé£Ÿç§€ (15:00)", location: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨" },
                  { id: 202, time: "13:00", type: "food", title: "èŠ±äººé€¢", note: "å¿…é»èœå–®ï¼šæ‰‹å·¥æŠ«è–©ï¼Œé¢¨æ™¯å¾ˆç¾", location: "èŠ±äººé€¢" },
                ]
              }
            ]
          }
        ];

        const ACTIVITY_TYPES = {
          sightseeing: { label: "æ™¯é»", icon: Camera, color: "text-rose-700 bg-rose-50 border-rose-200" }, 
          food: { label: "ç¾é£Ÿ", icon: Utensils, color: "text-amber-700 bg-amber-50 border-amber-200" }, 
          transport: { label: "äº¤é€š", icon: Car, color: "text-stone-600 bg-stone-100 border-stone-300" }, 
          accommodation: { label: "ä½å®¿", icon: Bed, color: "text-emerald-700 bg-emerald-50 border-emerald-200" }, 
          shopping: { label: "è³¼ç‰©", icon: MapPin, color: "text-indigo-700 bg-indigo-50 border-indigo-200" }, 
          other: { label: "å…¶ä»–", icon: MapPin, color: "text-gray-600 bg-gray-50 border-gray-200" },
        };

        // --- Helper Function: è¨ˆç®—æ—¥æœŸ (ä¿®å¾©æ™‚å€å•é¡Œ) ---
        const calculateDate = (startDate, dayIndex) => {
            if (!startDate) return "";
            try {
                // æ‰‹å‹•è§£æ YYYY-MM-DDï¼Œé¿å… new Date() çš„ UTC æ™‚å€åç§»å•é¡Œ
                const parts = startDate.split('-');
                if (parts.length !== 3) return ""; // æ ¼å¼ä¸å°å°±å›å‚³ç©º
                
                const year = parseInt(parts[0]);
                const monthIndex = parseInt(parts[1]) - 1; // æœˆä»½å¾ 0 é–‹å§‹
                const day = parseInt(parts[2]);

                const date = new Date(year, monthIndex, day);
                date.setDate(date.getDate() + dayIndex); // åŠ ä¸Šå¤©æ•¸åç§»
                
                const m = date.getMonth() + 1;
                const d = date.getDate();
                const weekDay = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][date.getDay()];
                return `${m}/${d} (${weekDay})`;
            } catch (e) {
                return "";
            }
        };

        async function callGemini(prompt, responseMimeType = "application/json") {
          try {
            const userApiKey = localStorage.getItem('travel_flow_api_key');
            const effectiveApiKey = apiKey || userApiKey || "";
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveApiKey}`,
              { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: responseMimeType } }) }
            );
            if (!response.ok) {
                if (response.status === 400 || response.status === 403) {
                    throw new Error("API Key ç„¡æ•ˆæˆ–æœªè¨­å®šã€‚è«‹é»æ“Šå³ä¸Šè§’è¨­å®š (âš™ï¸)ï¼Œè¼¸å…¥æ‚¨çš„ Google Gemini API Keyã€‚");
                }
                throw new Error(`API é€£ç·šéŒ¯èª¤: ${response.statusText}`);
            }
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (responseMimeType === "application/json" && text) return JSON.parse(text);
            return text;
          } catch (error) { console.error("Gemini API Error:", error); throw error; }
        }

        const HighlightTags = ({ text }) => {
          if (!text || typeof text !== 'string') return null;
          const keywords = [
            { key: "å¿…åƒ", color: "bg-red-100 text-red-600 border border-red-200" },
            { key: "å¿…è²·", color: "bg-pink-100 text-pink-600 border border-pink-200" },
            { key: "å¿…å»", color: "bg-teal-100 text-teal-600 border border-teal-200" },
            { key: "é ç´„", color: "bg-amber-100 text-amber-800 border border-amber-200" },
            { key: "æ³¨æ„", color: "bg-red-50 text-red-600 border border-red-200" },
          ];
          return (
            <div className="flex flex-wrap gap-1 mt-2">
              {keywords.map(k => {
                if (text.includes(k.key)) {
                  return <span key={k.key} className={`text-[10px] px-2 py-0.5 rounded-full ${k.color} font-medium`}>{k.key}é‡é»</span>
                }
                return null;
              })}
            </div>
          );
        };

        const SakuraBackground = () => {
            const containerRef = useRef(null);
            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;
                const createPetal = () => {
                    const petal = document.createElement('div');
                    petal.classList.add('petal');
                    const size = Math.random() * 10 + 8 + 'px';
                    const left = Math.random() * 100 + 'vw';
                    const duration = Math.random() * 5 + 6 + 's';
                    const delay = Math.random() * 5 + 's';
                    petal.style.width = size;
                    petal.style.height = size;
                    petal.style.left = left;
                    petal.style.animationDuration = duration;
                    petal.style.animationDelay = delay;
                    container.appendChild(petal);
                    setTimeout(() => { if(petal && container.contains(petal)) container.removeChild(petal); }, 12000); 
                };
                const interval = setInterval(createPetal, 600);
                for(let i=0; i<5; i++) createPetal();
                return () => clearInterval(interval);
            }, []);
            return <div ref={containerRef} className="fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>;
        };

        const JapaneseDecoration = () => (
            <div className="fixed bottom-0 right-0 opacity-10 pointer-events-none z-0">
                <svg width="200" height="150" viewBox="0 0 200 150" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M40 120 L40 60 M100 120 L100 60 M20 60 L120 60 M30 75 L110 75 M25 50 L115 50" stroke="#e11d48" strokeWidth="4" strokeLinecap="round" />
                    <path d="M120 120 L160 50 L200 120" fill="#94a3b8" />
                    <path d="M148 70 L160 50 L172 70" fill="white" />
                </svg>
            </div>
        );

        function DraggableMapWindow({ location, onClose }) {
            const [position, setPosition] = useState({ x: 20, y: 100 }); 
            const [isDragging, setIsDragging] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const windowRef = useRef(null);

            const handleStart = (clientX, clientY) => {
                if (windowRef.current) {
                    setIsDragging(true);
                    const rect = windowRef.current.getBoundingClientRect();
                    setDragOffset({
                        x: clientX - rect.left,
                        y: clientY - rect.top
                    });
                }
            };

            const onMouseDown = (e) => handleStart(e.clientX, e.clientY);
            const onTouchStart = (e) => handleStart(e.touches[0].clientX, e.touches[0].clientY);

            useEffect(() => {
                const handleMove = (clientX, clientY) => {
                    if (isDragging) {
                        const newX = Math.max(0, Math.min(window.innerWidth - 320, clientX - dragOffset.x)); 
                        const newY = Math.max(0, Math.min(window.innerHeight - 300, clientY - dragOffset.y)); 
                        setPosition({ x: newX, y: newY });
                    }
                };

                const onMouseMove = (e) => handleMove(e.clientX, e.clientY);
                const onTouchMove = (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY);
                const onEnd = () => setIsDragging(false);

                if (isDragging) {
                    window.addEventListener('mousemove', onMouseMove);
                    window.addEventListener('mouseup', onEnd);
                    window.addEventListener('touchmove', onTouchMove, { passive: false });
                    window.addEventListener('touchend', onEnd);
                }

                return () => {
                    window.removeEventListener('mousemove', onMouseMove);
                    window.removeEventListener('mouseup', onEnd);
                    window.removeEventListener('touchmove', onTouchMove);
                    window.removeEventListener('touchend', onEnd);
                };
            }, [isDragging, dragOffset]);

            return (
                <div 
                    ref={windowRef}
                    className="fixed z-50 w-80 bg-white rounded-2xl overflow-hidden border border-stone-200 map-window-shadow animate-in zoom-in-95 duration-200"
                    style={{ left: position.x, top: position.y }}
                >
                    <div 
                        className="bg-stone-800 text-white px-3 py-2 flex justify-between items-center cursor-move touch-none"
                        onMouseDown={onMouseDown}
                        onTouchStart={onTouchStart}
                    >
                        <div className="flex items-center gap-2 text-sm font-bold truncate">
                            <Move size={14} className="opacity-50"/> 
                            <span className="truncate max-w-[200px]">{location}</span>
                        </div>
                        <button onClick={onClose} className="p-1 hover:bg-stone-600 rounded-full transition-colors">
                            <X size={16} />
                        </button>
                    </div>
                    <div className="h-64 bg-stone-100 relative">
                         <iframe 
                            width="100%" 
                            height="100%" 
                            frameBorder="0" 
                            src={`https://maps.google.com/maps?q=${encodeURIComponent(location)}&t=&z=15&ie=UTF8&iwloc=&output=embed`}
                            style={{ border: 0 }} 
                            allowFullScreen
                        ></iframe>
                        {isDragging && <div className="absolute inset-0 bg-transparent z-10"></div>}
                    </div>
                    <div className="p-2 bg-stone-50 flex justify-between items-center text-xs text-stone-500">
                        <span>é•·æŒ‰æ¨™é¡Œåˆ—å¯æ‹–æ›³ç§»å‹•</span>
                        <a 
                            href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location)}&travelmode=driving`} 
                            target="_blank"
                            className="flex items-center gap-1 text-blue-600 font-bold px-2 py-1 hover:bg-blue-50 rounded"
                        >
                            <Navigation size={12}/> é–‹å•Ÿå°èˆª
                        </a>
                    </div>
                </div>
            );
        }

        function WeatherWidget({ location }) {
            const [weather, setWeather] = useState(null);
            useEffect(() => {
                if (!location) return;
                fetch(`https://wttr.in/${location.split(' ')[0]}?format=%C+%t`)
                    .then(res => { if (res.ok) return res.text(); throw new Error('Weather fetch failed'); })
                    .then(text => setWeather(text))
                    .catch(() => setWeather(null));
            }, [location]);
            if (!weather) return null;
            return <div className="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100 text-blue-600 text-sm font-medium animate-in fade-in"><CloudSun size={16} /><span>{weather}</span></div>;
        }

        function GuideSection({ day, tripTitle, dayIndex }) {
            const [guideInfo, setGuideInfo] = useState(day.guideInfo || null);
            const [isLoading, setIsLoading] = useState(false);
            const [isExpanded, setIsExpanded] = useState(false);

            const handleCallGuide = async () => {
                setIsLoading(true);
                setIsExpanded(true);
                
                const activitiesList = day.activities.map(a => `${a.time} ${a.title} (${a.type})`).join(', ');
                const foodSpots = day.activities.filter(a => a.type === 'food').map(a => a.title).join(', ');
                
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—¥æœ¬æ—…éŠå°éŠã€‚è«‹é‡å°ä»¥ä¸‹é€™å¤©çš„è¡Œç¨‹é€²è¡Œè§£èªªï¼š
                è¡Œç¨‹åç¨±ï¼š${tripTitle} Day ${dayIndex + 1}
                åœ°é»/ä½å®¿ï¼š${day.hotel || "æœªçŸ¥"}
                æ´»å‹•ï¼š${activitiesList}
                
                è«‹æä¾›ä»¥ä¸‹è³‡è¨Š (JSON æ ¼å¼)ï¼š
                1. intro: ä¸€æ®µç´„ 100 å­—çš„è¡Œç¨‹ä»‹ç´¹ï¼ŒåŒ…å«æ™¯é»çš„æ­·å²æˆ–ç‰¹è‰²æ•…äº‹ï¼Œèªæ°£è¦ªåˆ‡å°ˆæ¥­ã€‚
                2. weatherAdvice: æ ¹æ“šå­£ç¯€èˆ‡æ´»å‹•å…§å®¹ï¼Œçµ¦äºˆä¸€æ®µç©¿æ­èˆ‡å¤©æ°£å»ºè­°ã€‚
                3. foodTips: è‹¥è¡Œç¨‹ä¸­æœ‰é¤å»³ (${foodSpots})ï¼Œè«‹åˆ—å‡ºæ¨è–¦çš„ã€Œå¿…é»èœå–®ã€ï¼›è‹¥ç„¡ï¼Œå‰‡æ¨è–¦è©²åœ°å€çš„ç‰¹è‰²ç¾é£Ÿã€‚æ ¼å¼ç‚º "é¤å»³å: æ¨è–¦èœè‰²"ã€‚
                `;

                try {
                    const result = await callGemini(prompt);
                    setGuideInfo(result);
                } catch (e) {
                    alert(e.message);
                    setIsExpanded(false);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="mt-4 mb-6">
                    {!isExpanded && !guideInfo ? (
                        <button 
                            onClick={handleCallGuide}
                            className="w-full py-3 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl text-amber-800 font-bold flex items-center justify-center gap-2 hover:from-amber-100 hover:to-orange-100 transition-all shadow-sm"
                        >
                            {isLoading ? <Loader2 className="animate-spin" /> : <UserCheck size={18} />}
                            {isLoading ? "å°éŠæº–å‚™ä¸­..." : "å‘¼å«å°éŠ & ç¾é£Ÿæ¨è–¦"}
                        </button>
                    ) : (
                        <div className="bg-white rounded-xl border border-stone-200 shadow-sm overflow-hidden guide-section">
                            <div className="bg-amber-50 px-4 py-3 border-b border-amber-100 flex justify-between items-center">
                                <h4 className="font-bold text-amber-900 flex items-center gap-2 japanese-font">
                                    <UserCheck size={18}/> å°éŠç­†è¨˜
                                </h4>
                                <button onClick={() => setIsExpanded(false)} className="text-amber-400 hover:text-amber-600"><X size={16}/></button>
                            </div>
                            
                            {isLoading ? (
                                <div className="p-6 text-center text-stone-400 flex flex-col items-center gap-2">
                                    <Loader2 className="animate-spin" size={24}/>
                                    <p className="text-xs">æ­£åœ¨ç¿»é–±æ—…éŠæŒ‡å—...</p>
                                </div>
                            ) : guideInfo ? (
                                <div className="p-4 space-y-4 text-sm text-stone-700">
                                    <div className="flex gap-3">
                                        <div className="mt-1 flex-shrink-0"><MapPin size={16} className="text-rose-500"/></div>
                                        <p className="leading-relaxed text-stone-600">{guideInfo.intro}</p>
                                    </div>
                                    
                                    <div className="flex gap-3 bg-blue-50 p-3 rounded-lg border border-blue-100">
                                        <div className="mt-0.5 flex-shrink-0"><CloudSun size={16} className="text-blue-500"/></div>
                                        <div>
                                            <span className="font-bold text-blue-700 block mb-1">ç©¿æ­å»ºè­°</span>
                                            <p className="text-blue-600/80">{guideInfo.weatherAdvice}</p>
                                        </div>
                                    </div>

                                    {guideInfo.foodTips && (
                                        <div className="flex gap-3 bg-orange-50 p-3 rounded-lg border border-orange-100">
                                            <div className="mt-0.5 flex-shrink-0"><UtensilsCrossed size={16} className="text-orange-500"/></div>
                                            <div className="w-full">
                                                <span className="font-bold text-orange-700 block mb-1">ç¾é£Ÿæ”»ç•¥</span>
                                                <ul className="list-disc list-inside text-orange-600/80 space-y-1">
                                                    {typeof guideInfo.foodTips === 'string' ? <li>{guideInfo.foodTips}</li> : Object.entries(guideInfo.foodTips).map(([store, dish], i) => (<li key={i}><span className="font-bold">{store}</span>: {Array.isArray(dish) ? dish.join('ã€') : dish}</li>))}
                                                </ul>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : null}
                        </div>
                    )}
                </div>
            );
        }

        function ActivityGuide({ activity }) {
            const [info, setInfo] = useState(null);
            const [loading, setLoading] = useState(false);
            const [show, setShow] = useState(false);
            
            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(activity.location + " " + activity.title + " scenery photorealistic Japan travel")}`;
            const googleMapsImagesUrl = `https://www.google.com/search?q=${encodeURIComponent(activity.location + " ç…§ç‰‡")}&tbm=isch`;

            const fetchGuideInfo = async () => {
                if (info) { setShow(!show); return; }
                setLoading(true);
                setShow(true);
                
                const prompt = `é‡å°åœ°é»ã€Œ${activity.title} (${activity.location})ã€æä¾›æ·±åº¦å°éŠä»‹ç´¹ã€‚
                é¡å‹ï¼š${activity.type}
                è«‹å›å‚³ JSONï¼š
                {
                    "intro": "200-300å­—æ·±åº¦ä»‹ç´¹ï¼Œè¬›è¿°æ­·å²æ•…äº‹ã€å»ºç¯‰ç‰¹è‰²æˆ–åœ¨åœ°è»¼èã€‚èªæ°£è¦åƒå°ˆæ¥­å°éŠã€‚",
                    "highlight": "å¿…æ‹äº®é»æˆ–ç¨ç‰¹é«”é©— (Pro Tips)",
                    "food": "å¦‚æœæ˜¯é¤å»³ï¼Œæ¨è–¦3é“å¿…é»èœï¼›å¦‚æœæ˜¯æ™¯é»ï¼Œæ¨è–¦é™„è¿‘ç‰¹è‰²å°åƒ/ä¼´æ‰‹ç¦®ã€‚"
                }`;

                try {
                    const res = await callGemini(prompt);
                    setInfo(res);
                } catch (e) {
                    alert(e.message);
                    setShow(false);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="mt-3">
                    <button onClick={fetchGuideInfo} className={`text-xs font-bold flex items-center gap-1 px-3 py-1.5 rounded-full transition-colors ${show ? 'bg-amber-100 text-amber-700' : 'bg-stone-100 text-stone-500 hover:bg-amber-50 hover:text-amber-600'}`}>
                        <UserCheck size={14} /> {show ? "æ”¶èµ·å°éŠ" : "å°éŠä»‹ç´¹"}
                    </button>

                    {show && (
                        <div className="mt-3 bg-[#fffbf0] rounded-xl border border-amber-100 overflow-hidden guide-content">
                            <div className="h-32 w-full bg-stone-200 relative overflow-hidden group">
                                <img src={imageUrl} alt={activity.title} className="w-full h-full object-cover transition-transform duration-700 hover:scale-110" onError={(e) => e.target.style.display = 'none'} />
                                <a href={googleMapsImagesUrl} target="_blank" className="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded-full flex items-center gap-1 hover:bg-black/80 backdrop-blur-sm"><ImageIcon size={10} /> Google ç…§ç‰‡</a>
                            </div>

                            <div className="p-4">
                                {loading ? (
                                    <div className="flex justify-center py-4 text-amber-400"><Loader2 className="animate-spin" /></div>
                                ) : info ? (
                                    <div className="space-y-3 text-sm text-stone-700">
                                        <div>
                                            <h5 className="font-bold text-amber-800 flex items-center gap-1 mb-1"><MapPin size={12}/> æ™¯é»æ•…äº‹</h5>
                                            <p className="text-stone-600 leading-relaxed text-justify">{info.intro}</p>
                                        </div>
                                        <div className="grid grid-cols-1 gap-2">
                                            <div className="bg-white p-2 rounded-lg border border-amber-100"><span className="text-xs font-bold text-rose-500 block">âœ¨ å°ˆæ¥­å»ºè­° (Pro Tips)</span><span className="text-xs text-stone-600">{info.highlight}</span></div>
                                            <div className="bg-white p-2 rounded-lg border border-amber-100"><span className="text-xs font-bold text-orange-500 block">ğŸ± ç¾é£Ÿ/ä¼´æ‰‹ç¦®</span><span className="text-xs text-stone-600">{info.food}</span></div>
                                        </div>
                                    </div>
                                ) : <div className="text-center text-xs text-red-400">è¼‰å…¥å¤±æ•—</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ActivityItem({ activity, onUpdate, onDelete, openNavigation, onOpenMap }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editedActivity, setEditedActivity] = useState(activity);
            const typeConfig = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES.other;

            const handleSave = () => { onUpdate(editedActivity); setIsEditing(false); };

            if (isEditing) {
                return (
                    <div className="bg-white/95 p-4 rounded-xl shadow-md border border-stone-200 mb-4 animate-in fade-in relative z-10">
                        <div className="space-y-3">
                            <div className="flex gap-2">
                                <input type="time" value={editedActivity.time} onChange={(e) => setEditedActivity({...editedActivity, time: e.target.value})} className="p-2 border border-stone-200 rounded-lg text-sm bg-stone-50" />
                                <select value={editedActivity.type} onChange={(e) => setEditedActivity({...editedActivity, type: e.target.value})} className="flex-1 p-2 border border-stone-200 rounded-lg text-sm bg-stone-50">
                                    {Object.entries(ACTIVITY_TYPES).map(([key, config]) => (<option key={key} value={key}>{config.label}</option>))}
                                </select>
                            </div>
                            <input type="text" placeholder="æ¨™é¡Œ" value={editedActivity.title} onChange={(e) => setEditedActivity({...editedActivity, title: e.target.value})} className="w-full p-2 border border-stone-200 rounded-lg font-bold text-lg" />
                            <input type="text" placeholder="åœ°é» (Google Maps)" value={editedActivity.location} onChange={(e) => setEditedActivity({...editedActivity, location: e.target.value})} className="w-full p-2 border border-stone-200 rounded-lg text-sm" />
                            <textarea placeholder="å‚™è¨»: å¿…åƒç¾é£Ÿã€é ç´„ä»£è™Ÿ..." value={editedActivity.note} onChange={(e) => setEditedActivity({...editedActivity, note: e.target.value})} className="w-full p-2 border border-stone-200 rounded-lg text-sm h-20 resize-none"></textarea>
                            <div className="flex gap-2 justify-end">
                                <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-stone-500 hover:bg-stone-100 rounded-lg text-sm">å–æ¶ˆ</button>
                                <button onClick={handleSave} className="px-4 py-2 btn-sakura text-white rounded-lg text-sm shadow-sm hover:opacity-90">å„²å­˜</button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            const dotColor = typeConfig.color ? typeConfig.color.split(' ')[1] : 'bg-gray-400';

            return (
                <div className="relative pl-6 pb-8 group last:pb-0 z-10">
                    <div className="absolute left-[7px] top-3 bottom-0 w-px bg-stone-300 group-last:hidden"></div>
                    <div className={`absolute left-0 top-1.5 w-4 h-4 rounded-full border-2 border-[#fffbf0] shadow-sm z-10 ${dotColor}`}></div>
                    <div className="bg-white/90 backdrop-blur-sm rounded-xl p-4 shadow-sm border border-stone-200 hover:shadow-md transition-all relative overflow-hidden">
                        <div className="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onClick={() => setIsEditing(true)} className="p-1.5 text-stone-400 hover:text-rose-500 rounded-full hover:bg-rose-50"><Pencil size={14} /></button>
                            <button onClick={() => onDelete(activity.id)} className="p-1.5 text-stone-400 hover:text-red-500 rounded-full hover:bg-red-50"><Trash2 size={14} /></button>
                        </div>
                        <div className="flex justify-between items-start mb-2 pr-12">
                            <div>
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-mono text-sm font-bold text-stone-500">{activity.time}</span>
                                    <span className={`text-[10px] px-2 py-0.5 rounded-full ${typeConfig.color}`}>{typeConfig.label}</span>
                                </div>
                                <h3 className="font-bold text-stone-800 text-lg japanese-font">{activity.title}</h3>
                            </div>
                        </div>
                        {activity.location && (
                            <div className="flex flex-col gap-2 mb-3">
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center gap-1 text-sm text-stone-500 truncate max-w-[200px]">
                                        <MapPin size={14} className="text-rose-400"/><span>{activity.location}</span>
                                    </div>
                                    <button onClick={() => openNavigation(activity.location)} className="flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 rounded-full text-xs font-medium hover:bg-blue-100 transition-colors">
                                        <Navigation size={12} /> å°èˆª
                                    </button>
                                </div>
                                <button onClick={() => onOpenMap(activity.location)} className="flex items-center gap-1 text-xs font-bold text-stone-400 hover:text-rose-500 transition-colors self-start ml-5"><Map size={12} /> é è¦½åœ°åœ–</button>
                            </div>
                        )}
                        {activity.note && (
                            <div className="text-sm text-stone-600 bg-[#fdfcf6] p-3 rounded-lg border border-stone-100 mt-2">
                                <p className="whitespace-pre-wrap">{activity.note}</p>
                                <HighlightTags text={activity.note} />
                            </div>
                        )}
                        <ActivityGuide activity={activity} />
                    </div>
                </div>
            );
        }

        const ToolsView = ({ trip, onUpdate }) => {
            const [newExpense, setNewExpense] = useState({ title: "", amount: "", currency: "JPY" });
            const [newContact, setNewContact] = useState({ name: "", phone: "" });
            const totalExpense = (trip.expenses || []).reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);

            const addExpense = () => {
                if (!newExpense.title || !newExpense.amount) return;
                const updatedExpenses = [...(trip.expenses || []), { ...newExpense, id: generateId(), amount: Number(newExpense.amount) }];
                onUpdate(trip.id, { expenses: updatedExpenses });
                setNewExpense({ title: "", amount: "", currency: "JPY" });
            };
            const deleteExpense = (id) => onUpdate(trip.id, { expenses: trip.expenses.filter(e => e.id !== id) });
            const addContact = () => {
                if (!newContact.name || !newContact.phone) return;
                const updatedContacts = [...(trip.emergencyContacts || []), { ...newContact, id: generateId() }];
                onUpdate(trip.id, { emergencyContacts: updatedContacts });
                setNewContact({ name: "", phone: "" });
            };
            const deleteContact = (id) => onUpdate(trip.id, { emergencyContacts: trip.emergencyContacts.filter(c => c.id !== id) });

            return (
                <div className="p-4 md:p-8 max-w-4xl mx-auto space-y-6 pb-32 relative z-10">
                    <h2 className="text-2xl font-bold text-stone-800 mb-6 japanese-font flex items-center gap-2">
                         <Settings size={24} className="text-rose-500" /> æ—…ç¨‹å·¥å…·ç®±
                    </h2>
                    <div className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-stone-200 relative overflow-hidden">
                        <h3 className="font-bold text-stone-700 mb-4 flex items-center gap-2 japanese-font"><Plane size={20} className="text-rose-500"/> èˆªç­è³‡è¨Š</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-stone-50 p-4 rounded-xl border border-stone-100">
                                <div className="text-xs text-stone-400 font-bold uppercase mb-1">å»ç¨‹ Arrival</div>
                                <div className="text-lg font-bold text-stone-800">{trip.arrival?.time || "--:--"}</div>
                                <div className="text-stone-600">{trip.arrival?.location || "æœªè¨­å®š"}</div>
                            </div>
                            <div className="bg-stone-50 p-4 rounded-xl border border-stone-100">
                                <div className="text-xs text-stone-400 font-bold uppercase mb-1">å›ç¨‹ Departure</div>
                                <div className="text-lg font-bold text-stone-800">{trip.departure?.time || "--:--"}</div>
                                <div className="text-stone-600">{trip.departure?.location || "æœªè¨­å®š"}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-stone-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-stone-700 flex items-center gap-2 japanese-font"><Wallet size={20} className="text-rose-500"/> è¨˜å¸³/é ç®—</h3>
                            <div className="text-sm bg-rose-50 text-rose-700 px-3 py-1 rounded-full font-bold">ç¸½è¨ˆ: {totalExpense.toLocaleString()}</div>
                        </div>
                        <div className="flex gap-2 mb-4">
                            <input type="text" placeholder="é …ç›®" value={newExpense.title} onChange={e => setNewExpense({...newExpense, title: e.target.value})} className="flex-1 p-2 border border-stone-200 rounded-lg text-sm" />
                            <input type="number" placeholder="é‡‘é¡" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} className="w-24 p-2 border border-stone-200 rounded-lg text-sm" />
                            <button onClick={addExpense} className="p-2 btn-sakura text-white rounded-lg"><Plus size={20}/></button>
                        </div>
                        <div className="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                            {(trip.expenses || []).map(exp => (
                                <div key={exp.id} className="flex justify-between items-center bg-stone-50 p-2 rounded-lg text-sm">
                                    <span className="text-stone-700">{exp.title}</span>
                                    <div className="flex items-center gap-3">
                                        <span className="font-mono font-bold">{Number(exp.amount).toLocaleString()}</span>
                                        <button onClick={() => deleteExpense(exp.id)} className="text-stone-400 hover:text-red-500"><X size={14}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-stone-200">
                        <h3 className="font-bold text-stone-700 mb-4 flex items-center gap-2 japanese-font"><Phone size={20} className="text-rose-500"/> ç·Šæ€¥è¯çµ¡</h3>
                        <div className="flex gap-2 mb-4">
                            <input type="text" placeholder="åç¨±" value={newContact.name} onChange={e => setNewContact({...newContact, name: e.target.value})} className="flex-1 p-2 border border-stone-200 rounded-lg text-sm" />
                            <input type="tel" placeholder="é›»è©±" value={newContact.phone} onChange={e => setNewContact({...newContact, phone: e.target.value})} className="flex-1 p-2 border border-stone-200 rounded-lg text-sm" />
                            <button onClick={addContact} className="p-2 btn-sakura text-white rounded-lg"><Plus size={20}/></button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {(trip.emergencyContacts || []).map(contact => (
                                <div key={contact.id} className="flex justify-between items-center bg-red-50 p-3 rounded-xl border border-red-100">
                                    <div><div className="text-xs text-red-400 font-bold">{contact.name}</div><div className="text-red-800 font-mono font-bold">{contact.phone}</div></div>
                                    <button onClick={() => deleteContact(contact.id)} className="text-red-300 hover:text-red-600"><X size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Modals
        function FlightDetailModal({ isOpen, onClose, currentTrip, onUpdateTrip }) {
            const [arrivalDetails, setArrivalDetails] = useState({ time: "", location: "", ...(currentTrip?.arrival || {}) });
            const [departureDetails, setDepartureDetails] = useState({ time: "", location: "", ...(currentTrip?.departure || {}) });

            useEffect(() => {
                if (isOpen && currentTrip) {
                    setArrivalDetails({ time: "", location: "", ...(currentTrip.arrival || {}) });
                    setDepartureDetails({ time: "", location: "", ...(currentTrip.departure || {}) });
                }
            }, [isOpen, currentTrip]);

            if (!isOpen) return null;
            const handleSave = () => { onUpdateTrip(currentTrip.id, { arrival: arrivalDetails, departure: departureDetails }); onClose(); };

            return (
                <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-end md:items-center justify-center z-50 p-0 md:p-4 overflow-y-auto">
                    <div className="bg-white rounded-t-3xl md:rounded-3xl w-full max-w-lg p-6 pb-10 md:pb-6 shadow-2xl animate-in slide-in-from-bottom duration-200 max-h-[90vh] overflow-y-auto relative overflow-hidden">
                         <div className="absolute top-0 right-0 opacity-10 pointer-events-none"><Plane size={120} className="text-stone-300"/></div>
                        <div className="flex justify-between items-center mb-6 relative z-10">
                            <h3 className="text-xl font-bold text-stone-800 flex items-center gap-2 japanese-font"><Plane size={24} className="text-rose-500"/> èˆªç­è¨­å®š</h3>
                            <button onClick={onClose} className="p-2 text-stone-400 hover:bg-stone-100 rounded-full"><X size={20} /></button>
                        </div>
                        <div className="space-y-6 relative z-10">
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h4 className="font-bold text-blue-800 mb-3 flex items-center gap-2"><Bus size={18}/> å»ç¨‹</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold text-blue-600 mb-1">æ™‚é–“</label><input type="time" value={arrivalDetails.time || ""} onChange={(e) => setArrivalDetails({...arrivalDetails, time: e.target.value})} className="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white" /></div>
                                    <div><label className="block text-xs font-bold text-blue-600 mb-1">åœ°é»</label><input type="text" value={arrivalDetails.location || ""} onChange={(e) => setArrivalDetails({...arrivalDetails, location: e.target.value})} placeholder="æ©Ÿå ´..." className="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white" /></div>
                                </div>
                            </div>
                            <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                                <h4 className="font-bold text-red-800 mb-3 flex items-center gap-2"><Plane size={18}/> å›ç¨‹</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold text-red-600 mb-1">æ™‚é–“</label><input type="time" value={departureDetails.time || ""} onChange={(e) => setDepartureDetails({...departureDetails, time: e.target.value})} className="w-full p-2 border border-red-200 rounded-lg text-sm bg-white" /></div>
                                    <div><label className="block text-xs font-bold text-red-600 mb-1">åœ°é»</label><input type="text" value={departureDetails.location || ""} onChange={(e) => setDepartureDetails({...departureDetails, location: e.target.value})} placeholder="æ©Ÿå ´..." className="w-full p-2 border border-red-200 rounded-lg text-sm bg-white" /></div>
                                </div>
                            </div>
                        </div>
                        <button onClick={handleSave} className="w-full mt-6 py-3.5 btn-sakura text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2 relative z-10"><Save size={20} /> å„²å­˜è¨­å®š</button>
                    </div>
                </div>
            );
        }
        
        function SettingsModal({ isOpen, onClose }) {
            const [apiKeyInput, setApiKeyInput] = useState("");

            useEffect(() => {
                if (isOpen) {
                    setApiKeyInput(localStorage.getItem('travel_flow_api_key') || "");
                }
            }, [isOpen]);

            const handleSave = () => {
                localStorage.setItem('travel_flow_api_key', apiKeyInput.trim());
                alert("API Key å·²å„²å­˜ï¼");
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-in fade-in zoom-in">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-stone-800 flex items-center gap-2 japanese-font"><Settings size={20}/> è¨­å®š</h3>
                            <button onClick={onClose} className="p-2 text-stone-400 hover:bg-stone-100 rounded-full"><X size={20} /></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-stone-700 mb-2 flex items-center gap-1">
                                    <Key size={16}/> Gemini API Key
                                </label>
                                <input 
                                    type="password" 
                                    value={apiKeyInput} 
                                    onChange={(e) => setApiKeyInput(e.target.value)} 
                                    placeholder="è²¼ä¸Šæ‚¨çš„ API Key..." 
                                    className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none text-sm"
                                />
                                <p className="text-xs text-stone-500 mt-2">
                                    éœ€è¦æ­¤ Key æ‰èƒ½ä½¿ç”¨ AI è¦åŠƒåŠŸèƒ½ã€‚<br/>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-rose-600 underline">åœ¨æ­¤å…è²»ç”³è«‹ Google AI Key</a>
                                </p>
                            </div>
                            <button onClick={handleSave} className="w-full py-3 btn-sakura text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition-all">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        }

        function MapImportModal({ isOpen, onClose, onImport, currentTrip, tripDuration }) {
            const [importText, setImportText] = useState("");
            const [parsedDays, setParsedDays] = useState([]); 
            const [importTitle, setImportTitle] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [currentStep, setCurrentStep] = useState(1); 
            
            const { arrival, departure } = currentTrip;
            const hotelsContext = (currentTrip.days || []).map((d, i) => `Day ${i + 1} ä½å®¿: ${d.hotel || "æœªè¨­å®š"}`).join('\n');

            const handleAIParseMapList = async () => {
                if (!importText) return;
                setIsLoading(true);
                setParsedDays([]);
                const arrivalInfo = arrival.time ? `è¡Œç¨‹ ${arrival.time} æŠµé”` : "";
                const prompt = `æ‚¨æ˜¯å°éŠã€‚è«‹å°‡ä»¥ä¸‹åœ°é»åˆ†é…åˆ° ${tripDuration} å¤©è¡Œç¨‹ã€‚åœ°é»ï¼š\n${importText}\nä½å®¿ï¼š\n${hotelsContext}\n${arrivalInfo}\nè«‹å›å‚³ JSON: { "tripTitle": "...", "days": [{ "dateTitle": "...", "activities": [{ "time": "HH:MM", "title": "...", "type": "sightseeing/food/shopping", "location": "...", "note": "ç‰¹è‰²èˆ‡å»ºè­°åœç•™æ™‚é–“..." }] }] }`;
                try {
                    const result = await callGemini(prompt);
                    setParsedDays(result.days); setImportTitle(result.tripTitle || currentTrip.title); setCurrentStep(2);
                } catch (error) { alert("AI è§£æå¤±æ•—: " + error.message); } finally { setIsLoading(false); }
            };
            
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-end md:items-center justify-center z-50 p-0 md:p-4 overflow-y-auto">
                    <div className="bg-white rounded-t-3xl md:rounded-3xl w-full max-w-lg p-6 pb-10 md:pb-6 shadow-2xl h-[85vh] md:h-auto flex flex-col animate-in slide-in-from-bottom duration-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-stone-800 flex items-center gap-2 japanese-font"><ListPlus size={24}/> æ™ºèƒ½åŒ¯å…¥</h3>
                            <button onClick={onClose} className="p-2 text-stone-400 hover:bg-stone-100 rounded-full"><X size={20} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            {currentStep === 1 ? (
                                <div className="space-y-4">
                                    <textarea placeholder="è²¼ä¸Šåœ°é»æ¸…å–®ï¼ŒAI å¹«æ‚¨æ’è·¯ç·š..." value={importText} onChange={(e) => setImportText(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl h-64 resize-none focus:ring-2 focus:ring-rose-500 outline-none"></textarea>
                                    <button onClick={handleAIParseMapList} disabled={!importText || isLoading} className="w-full py-4 btn-sakura text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 disabled:opacity-50">{isLoading ? <Loader2 className="animate-spin" /> : "é–‹å§‹è¦åŠƒ âœ¨"}</button>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <div className="p-3 bg-green-50 text-green-700 rounded-xl text-sm flex items-center gap-2 border border-green-100"><Check size={16}/> è¦åŠƒå®Œæˆ</div>
                                    {parsedDays.map((day, idx) => (
                                        <div key={idx} className="border border-stone-200 rounded-xl p-4">
                                            <h4 className="font-bold text-stone-800 mb-2 japanese-font">{day.dateTitle}</h4>
                                            <div className="space-y-2">{day.activities.map((a,i)=><div key={i} className="text-sm flex gap-2"><span className="text-rose-600 font-mono w-12">{a.time}</span><span className="truncate">{a.title}</span></div>)}</div>
                                        </div>
                                    ))}
                                    <button onClick={() => { onImport(parsedDays, importTitle); onClose(); }} className="w-full py-4 btn-sakura text-white font-bold rounded-xl shadow-lg hover:opacity-90">ç¢ºèªä½¿ç”¨æ­¤è¡Œç¨‹</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function RecommendationCard({ suggestion, onAdd }) {
            const typeConfig = ACTIVITY_TYPES[suggestion.type] || ACTIVITY_TYPES.other;
            return (
                <div className="bg-white p-3 rounded-xl border border-stone-200 shadow-sm hover:shadow-md transition-all mb-3 group relative">
                    <div className="flex justify-between items-start">
                        <div><h4 className="font-bold text-stone-800 text-sm japanese-font">{suggestion.title}</h4><p className="text-xs text-stone-500 flex items-center gap-1 mt-1"><MapPin size={10} /> {suggestion.location}</p></div>
                        <span className={`text-[10px] px-1.5 py-0.5 rounded border ${typeConfig.color.replace('bg-', 'bg-opacity-10 ')}`}>{typeConfig.label}</span>
                    </div>
                    <p className="text-xs text-stone-600 mt-2 line-clamp-2">{suggestion.note}</p>
                    <div className="mt-3 flex items-center justify-between">
                        <span className="text-xs font-semibold text-indigo-500 bg-indigo-50 px-2 py-1 rounded">å»ºè­°æ™‚é–“: {suggestion.time}</span>
                        <button onClick={() => onAdd(suggestion)} className="p-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-1 text-xs font-bold shadow-sm"><Plus size={14} /> åŠ å…¥</button>
                    </div>
                </div>
            );
        }

        function TravelPlanner() {
          const [trips, setTrips] = useState(() => { try { return JSON.parse(localStorage.getItem('travel_planner_trips')) || DEFAULT_TRIPS; } catch { return DEFAULT_TRIPS; } });
          const [activeTab, setActiveTab] = useState('itinerary'); 
          const [currentTripId, setCurrentTripId] = useState(null);
          const [currentDayIndex, setCurrentDayIndex] = useState(0);
          
          // UI States
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isImportModalOpen, setIsImportModalOpen] = useState(false);
          const [isFlightModalOpen, setIsFlightModalOpen] = useState(false);
          const [isSettingsOpen, setIsSettingsOpen] = useState(false); 
          const [showRecommendations, setShowRecommendations] = useState(false);
          const [recommendations, setRecommendations] = useState({});
          const [loadingRecs, setLoadingRecs] = useState(false);
          const [showCopyToast, setShowCopyToast] = useState(false);
          const [activeMapLocation, setActiveMapLocation] = useState(null); 
          
          const [isCreateOpen, setIsCreateOpen] = useState(false);
          const [newTripData, setNewTripData] = useState({ title: "", date: "", days: 3 });
          const [newActivity, setNewActivity] = useState({ time: "09:00", title: "", type: "sightseeing", location: "", note: "" });
          const [showInstallPrompt, setShowInstallPrompt] = useState(false);

          useEffect(() => { localStorage.setItem('travel_planner_trips', JSON.stringify(trips)); }, [trips]);

          useEffect(() => {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            if (isIOS && !isStandaloneMode && !localStorage.getItem('install_prompt_dismissed')) {
              const timer = setTimeout(() => setShowInstallPrompt(true), 2000);
              return () => clearTimeout(timer);
            }
          }, []);

          const currentTrip = trips.find(t => t.id === currentTripId);
          const currentDay = currentTrip ? currentTrip.days[currentDayIndex] : null;

          // ... (CRUD Logic same as before) ...
          const handleUpdateTrip = (id, data) => setTrips(trips.map(t => t.id === id ? { ...t, ...data } : t));
          const handleDeleteTrip = (id) => { if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) setTrips(trips.filter(t => t.id !== id)); setCurrentTripId(null); };
          
          const handleCreateTrip = () => {
              const newTrip = { 
                  id: generateId(), 
                  title: newTripData.title, 
                  startDate: newTripData.date, 
                  arrival: { time: "", location: "" }, 
                  departure: { time: "", location: "" }, 
                  expenses: [], 
                  emergencyContacts: [],
                  days: Array.from({length: newTripData.days}, (_, i) => ({ id: generateId(), date: `Day ${i+1}`, hotel: "", activities: [] }))
              };
              setTrips([...trips, newTrip]); setIsCreateOpen(false); setNewTripData({ title: "", date: "", days: 3 });
          };

          const handleUpdateActivity = (updatedAct) => {
              const updatedDays = currentTrip.days.map((day, idx) => {
                  if (idx !== currentDayIndex) return day;
                  const acts = day.activities.map(a => a.id === updatedAct.id ? updatedAct : a);
                  return { ...day, activities: acts.sort((a,b) => a.time.localeCompare(b.time)) };
              });
              handleUpdateTrip(currentTripId, { days: updatedDays });
          };
          
          const handleDeleteActivity = (id) => {
              const updatedDays = currentTrip.days.map((day, idx) => {
                  if (idx !== currentDayIndex) return day;
                  return { ...day, activities: day.activities.filter(a => a.id !== id) };
              });
              handleUpdateTrip(currentTripId, { days: updatedDays });
          };

          const handleAddActivity = () => {
              if(!newActivity.title) return;
              const act = { ...newActivity, id: generateId() };
              const updatedDays = currentTrip.days.map((day, idx) => {
                  if (idx !== currentDayIndex) return day;
                  return { ...day, activities: [...day.activities, act].sort((a,b) => a.time.localeCompare(b.time)) };
              });
              handleUpdateTrip(currentTripId, { days: updatedDays });
              setIsModalOpen(false); setNewActivity({ time: "09:00", title: "", type: "sightseeing", location: "", note: "" });
          };

          const insertActivities = (activitiesToAdd) => {
            const updatedDays = currentTrip.days.map((day, idx) => {
                if (idx !== currentDayIndex) return day;
                const newActs = [...day.activities, ...activitiesToAdd].sort((a, b) => a.time.localeCompare(b.time));
                return { ...day, activities: newActs };
            });
            handleUpdateTrip(currentTripId, { days: updatedDays });
          };

          // ... (Import, Suggestion, Weather, Copy Logic same as before) ...
          const handleImportMapList = (newTripDays, newTripTitle) => {
              const updatedTrips = trips.map(t => {
                  if (t.id === currentTripId) {
                      return { 
                          ...t, 
                          title: newTripTitle,
                          days: newTripDays.map((day, idx) => ({
                              id: generateId(),
                              date: day.dateTitle || `Day ${idx + 1}`,
                              hotel: t.days[idx]?.hotel || "", 
                              weather: "sunny",
                              activities: day.activities.map(act => ({ ...act, id: generateId() }))
                          }))
                      };
                  } 
                  return t;
              });
              setTrips(updatedTrips);
              setCurrentDayIndex(0);
          };

          const openNavigation = (loc) => window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(loc)}&travelmode=driving`, '_blank');
          
          const handleGetRecommendations = async () => {
              setLoadingRecs(true);
              const prompt = `é‡å° ${currentTrip.title} Day ${currentDayIndex+1} (ä½å®¿: ${currentDay.hotel}) çš„è¡Œç¨‹ï¼š${currentDay.activities.map(a=>a.location).join(',')}ï¼Œæ¨è–¦ 3 å€‹é †è·¯æ™¯é»æˆ–é¤å»³ã€‚JSON: [{ "title": "...", "type": "...", "location": "...", "time": "HH:MM", "note": "..." }]`;
              try {
                  const res = await callGemini(prompt);
                  setRecommendations({...recommendations, [currentDayIndex]: res});
              } catch(e) { alert("ç„¡æ³•å–å¾—æ¨è–¦: " + e.message); } finally { setLoadingRecs(false); }
          };

          const handleAddRecommendation = (suggestion) => {
              const newActivity = {
                  id: generateId(),
                  time: suggestion.time || "12:00",
                  title: suggestion.title,
                  location: suggestion.location,
                  type: suggestion.type,
                  note: suggestion.note
              };
              insertActivities([newActivity]);
              setRecommendations(prev => ({
                  ...prev,
                  [currentDayIndex]: prev[currentDayIndex].filter(i => i.title !== suggestion.title)
              }));
          };

          const toggleWeather = () => {
              const weathers = ['sunny', 'cloudy', 'rainy'];
              const current = currentDay.weather || 'sunny';
              const next = weathers[(weathers.indexOf(current) + 1) % weathers.length];
              const updatedDays = [...currentTrip.days];
              updatedDays[currentDayIndex] = { ...updatedDays[currentDayIndex], weather: next };
              handleUpdateTrip(currentTripId, { days: updatedDays });
          };

          const handleCopyItinerary = () => {
              if (!currentTrip) return;
              let text = `âœˆï¸ ${currentTrip.title}\nğŸ“… ${currentTrip.startDate}\n`;
              text += `ğŸ›« æŠµé”: ${currentTrip.arrival?.time || 'NA'}\nğŸ›¬ é›¢é–‹: ${currentTrip.departure?.time || 'NA'}\n\n`;
              currentTrip.days.forEach((day, index) => {
                  text += `ã€${day.date}ã€‘ğŸ¨ ${day.hotel || "æœªå®š"}\n`;
                  if (day.activities.length === 0) text += `  (ç„¡è¡Œç¨‹)\n`;
                  else day.activities.forEach(act => text += `  ${act.time} ${act.title}\n`);
                  text += `\n`;
              });
              navigator.clipboard.writeText(text).then(() => {
                  setShowCopyToast(true); setTimeout(() => setShowCopyToast(false), 2000);
              });
          };
          
          const WeatherIcon = ({ type }) => {
              if (type === 'rainy') return <div className="flex items-center gap-1 text-blue-500"><CloudSun size={16}/> <span className="text-xs">é›¨å¤©</span></div>;
              if (type === 'cloudy') return <div className="flex items-center gap-1 text-stone-500"><CloudSun size={16}/> <span className="text-xs">å¤šé›²</span></div>;
              return <div className="flex items-center gap-1 text-orange-500"><Sun size={16}/> <span className="text-xs">æ™´æœ—</span></div>;
          };

          if (!currentTrip) {
              return (
                  <div className="h-[100dvh] w-full p-6 pb-24 overflow-y-auto relative z-10 scrolling-touch">
                      <SakuraBackground />
                      <JapaneseDecoration />
                      <header className="mb-8 pt-4 flex justify-between items-center relative z-10">
                          <div><h1 className="text-3xl font-bold text-stone-800 tracking-tight japanese-font flex items-center gap-2">TravelFlow <span className="text-2xl">â›©ï¸</span></h1><p className="text-stone-500">è¦åŠƒä½ çš„ä¸‹ä¸€æ®µæ—…ç¨‹ ğŸŒ¸</p></div>
                          <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-stone-400 hover:bg-white rounded-full"><Settings size={24}/></button>
                      </header>
                      <div className="grid gap-4 relative z-10">
                          {trips.map(trip => (
                              <div key={trip.id} onClick={() => { setCurrentTripId(trip.id); setActiveTab('itinerary'); }} className="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-stone-200 flex justify-between items-center cursor-pointer hover:shadow-md transition-all">
                                  <div><h3 className="font-bold text-stone-800 text-lg mb-1 japanese-font">{trip.title}</h3><p className="text-sm text-stone-500 flex items-center gap-2"><Calendar size={14} className="text-rose-400"/> {trip.startDate} Â· {trip.days.length} å¤©</p></div>
                                  <button onClick={(e) => { e.stopPropagation(); handleDeleteTrip(trip.id); }} className="p-2 text-stone-300 hover:text-red-400"><Trash2 size={18}/></button>
                              </div>
                          ))}
                          <button onClick={() => setIsCreateOpen(true)} className="mt-4 w-full py-4 border-2 border-dashed border-stone-300 text-stone-400 rounded-2xl font-bold hover:border-rose-400 hover:text-rose-500 transition-colors flex items-center justify-center gap-2"><Plus/> å»ºç«‹æ–°æ—…ç¨‹</button>
                      </div>
                      {isCreateOpen && (<div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div className="bg-white p-6 rounded-3xl w-full max-w-sm shadow-xl animate-in fade-in zoom-in"><h3 className="text-xl font-bold mb-4 text-stone-800 japanese-font">æ–°æ—…ç¨‹</h3><input type="text" placeholder="åç¨± (å¦‚: äº¬éƒ½è³æ¥“ä¹‹æ—…)" value={newTripData.title} onChange={e=>setNewTripData({...newTripData, title:e.target.value})} className="w-full mb-3 p-3 bg-stone-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-500" autoFocus /><input type="date" value={newTripData.date} onChange={e=>setNewTripData({...newTripData, date:e.target.value})} className="w-full mb-3 p-3 bg-stone-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-500" /><div className="flex justify-end gap-2 mt-4"><button onClick={()=>setIsCreateOpen(false)} className="px-4 py-2 text-stone-500">å–æ¶ˆ</button><button onClick={handleCreateTrip} disabled={!newTripData.title} className="px-6 py-2 btn-sakura text-white rounded-xl font-bold hover:opacity-90">å»ºç«‹</button></div></div></div>)}
                      <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} />
                  </div>
              );
          }

          // Detail View
          return (
              <div className="h-[100dvh] w-full flex flex-col font-sans text-stone-800 overflow-hidden relative">
                  <SakuraBackground />
                  
                  <header className="bg-white/90 backdrop-blur-sm px-4 py-3 border-b border-stone-200 flex justify-between items-center sticky top-0 z-30 shadow-sm flex-none">
                      <div className="flex items-center gap-3 overflow-hidden">
                          <button onClick={() => setCurrentTripId(null)} className="p-2 hover:bg-stone-50 rounded-full text-stone-500"><ChevronLeft/></button>
                          <div className="flex flex-col overflow-hidden">
                              <div className="flex items-baseline gap-2">
                                  <h1 className="font-bold text-lg truncate japanese-font">{currentTrip.title}</h1>
                                  <span className="text-sm font-medium text-stone-500">{calculateDate(currentTrip.startDate, currentDayIndex)}</span>
                              </div>
                              {currentTrip.days[currentDayIndex].hotel && (
                                  <div className="flex items-center gap-1"><WeatherWidget location={currentTrip.arrival.location || "Okinawa"} /></div>
                              )}
                          </div>
                      </div>
                      <div className="flex gap-2">
                          <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-stone-400 hover:bg-stone-50 rounded-full"><Settings size={20}/></button>
                          <button onClick={() => setShowRecommendations(!showRecommendations)} className={`p-2 rounded-full transition-colors ${showRecommendations ? 'bg-yellow-100 text-yellow-600' : 'text-stone-400 hover:bg-stone-50'}`}><Lightbulb size={20}/></button>
                          <button onClick={() => setIsFlightModalOpen(true)} className="p-2 text-rose-500 hover:bg-rose-50 rounded-full"><Plane size={20}/></button>
                          <button onClick={() => setIsImportModalOpen(true)} className="p-2 text-stone-600 hover:bg-stone-100 rounded-full"><ListPlus size={20}/></button>
                          <button onClick={handleCopyItinerary} className="p-2 text-stone-400 hover:bg-stone-100 rounded-full"><Copy size={20}/></button>
                      </div>
                  </header>

                  <div className="flex-1 relative flex overflow-hidden z-10 min-h-0">
                      {activeTab === 'itinerary' ? (
                          <div className="flex-1 flex flex-col h-full min-w-[320px] min-h-0">
                              {/* Day Navigator */}
                              <div className="flex overflow-x-auto p-2 gap-2 bg-white/50 backdrop-blur-sm border-b border-stone-200 no-scrollbar z-20 shadow-sm flex-none sticky top-0 scrolling-touch">
                                  {currentTrip.days.map((day, idx) => (
                                      <button key={day.id} onClick={() => setCurrentDayIndex(idx)} className={`flex-none px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${currentDayIndex === idx ? 'btn-sakura text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}`}>
                                          {/* Use calculated date or fallback */}
                                          {calculateDate(currentTrip.startDate, idx) || day.date}
                                      </button>
                                  ))}
                                  <button onClick={() => { const newDays = [...currentTrip.days, {id: generateId(), date: `Day ${currentTrip.days.length+1}`, activities:[]}]; handleUpdateTrip(currentTrip.id, {days: newDays}); setCurrentDayIndex(newDays.length-1); }} className="px-3 py-2 bg-white border border-stone-200 text-stone-400 rounded-full hover:bg-stone-50"><Plus size={16}/></button>
                              </div>

                              <div className="flex-1 overflow-y-auto scrolling-touch p-4 pb-24 custom-scrollbar relative overscroll-contain min-h-0">
                                  {/* Day Info */}
                                  <div className="bg-white/80 backdrop-blur-sm rounded-2xl p-4 shadow-sm border border-stone-200 mb-6 flex flex-col gap-3">
                                      <div className="flex justify-between items-start">
                                          <div className="flex items-baseline gap-2">
                                              <h2 className="text-2xl font-bold text-stone-800 japanese-font">Day {currentDayIndex + 1}</h2>
                                              <span className="text-lg font-medium text-stone-500">{calculateDate(currentTrip.startDate, currentDayIndex)}</span>
                                          </div>
                                          <button onClick={toggleWeather} className="bg-white px-2 py-1 rounded-lg border border-stone-200 hover:bg-stone-50"><WeatherIcon type={currentDay.weather} /></button>
                                      </div>
                                      <div className="flex items-center gap-2 bg-[#fdfcf6] p-3 rounded-xl border border-stone-200">
                                          <Bed size={18} className="text-emerald-600 flex-shrink-0" />
                                          <input type="text" placeholder="è¼¸å…¥ä»Šæ™šä½å®¿..." value={currentDay.hotel || ""} onChange={(e) => { const updatedDays = [...currentTrip.days]; updatedDays[currentDayIndex].hotel = e.target.value; handleUpdateTrip(currentTrip.id, { days: updatedDays }); }} className="bg-transparent w-full text-stone-700 font-medium placeholder-stone-400 outline-none"/>
                                      </div>
                                      <GuideSection day={currentDay} tripTitle={currentTrip.title} dayIndex={currentDayIndex} />
                                  </div>

                                  {/* Activity List */}
                                  <div className="space-y-0">
                                      {(currentDay.activities || []).length === 0 ? (
                                          <div className="text-center py-12 text-stone-400"><Map className="w-12 h-12 mx-auto mb-2 opacity-20"/><p>é»æ“Š + é–‹å§‹è¦åŠƒ</p></div>
                                      ) : (
                                          currentDay.activities.map(act => (
                                              <ActivityItem 
                                                key={act.id} 
                                                activity={act} 
                                                onUpdate={handleUpdateActivity} 
                                                onDelete={handleDeleteActivity} 
                                                openNavigation={openNavigation}
                                                onOpenMap={setActiveMapLocation} 
                                              />
                                          ))
                                      )}
                                  </div>
                              </div>
                          </div>
                      ) : (
                          <div className="flex-1 overflow-y-auto scrolling-touch min-w-[320px] min-h-0">
                              <ToolsView trip={currentTrip} onUpdate={handleUpdateTrip} />
                          </div>
                      )}

                      {showRecommendations && activeTab === 'itinerary' && (
                          <div className="absolute inset-y-0 right-0 w-full md:w-80 bg-white/95 backdrop-blur-md shadow-2xl z-40 flex flex-col animate-in slide-in-from-right duration-300 border-l border-stone-200">
                                {/* Recommendation Panel Content (Same as before) */}
                                <div className="p-4 border-b border-stone-200 flex justify-between items-center bg-amber-50/50">
                                  <h3 className="font-bold text-amber-800 flex items-center gap-2 japanese-font"><Lightbulb size={18}/> AI éˆæ„Ÿæ¨è–¦</h3>
                                  <button onClick={() => setShowRecommendations(false)} className="p-1 hover:bg-amber-100 rounded-full"><X size={18}/></button>
                              </div>
                              <div className="p-4 border-b border-stone-200">
                                  <button onClick={handleGetRecommendations} disabled={loadingRecs} className="w-full py-3 bg-white border border-amber-200 text-amber-700 font-bold rounded-xl shadow-sm hover:bg-amber-50 flex items-center justify-center gap-2 transition-all">
                                      {loadingRecs ? <Loader2 className="animate-spin"/> : <Sparkles/>} åˆ†æè¡Œç¨‹ä¸¦æ¨è–¦
                                  </button>
                              </div>
                              <div className="flex-1 overflow-y-auto p-4 space-y-3 scrolling-touch min-h-0">
                                  {(recommendations[currentDayIndex] || []).map((rec, i) => (
                                      <RecommendationCard key={i} suggestion={rec} onAdd={handleAddRecommendation} />
                                  ))}
                                  {(!recommendations[currentDayIndex] || recommendations[currentDayIndex].length === 0) && <div className="text-center text-stone-400 py-10 text-sm">é»æ“Šä¸Šæ–¹æŒ‰éˆ•<br/>è®“ AI å°‹æ‰¾é †è·¯æ™¯é»</div>}
                              </div>
                          </div>
                      )}
                  </div>

                  <nav className="bg-white/90 backdrop-blur-md border-t border-stone-200 px-6 py-3 flex justify-around items-center z-30 pb-safe flex-none">
                      <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeTab === 'itinerary' ? 'text-rose-600' : 'text-stone-400'}`}>
                          <Map size={24} strokeWidth={activeTab === 'itinerary' ? 2.5 : 2} />
                          <span className="text-[10px] font-bold">è¡Œç¨‹</span>
                      </button>
                      
                      {activeTab === 'itinerary' && (
                          <button onClick={() => setIsModalOpen(true)} className="btn-sakura text-white p-4 rounded-full shadow-lg shadow-rose-200 -mt-8 border-4 border-[#fffbf0] hover:scale-105 transition-transform">
                              <Plus size={24} />
                          </button>
                      )}

                      <button onClick={() => setActiveTab('tools')} className={`flex flex-col items-center gap-1 ${activeTab === 'tools' ? 'text-rose-600' : 'text-stone-400'}`}>
                          <LayoutGrid size={24} strokeWidth={activeTab === 'tools' ? 2.5 : 2} />
                          <span className="text-[10px] font-bold">å·¥å…·</span>
                      </button>
                  </nav>

                  {/* Add Modal */}
                  {isModalOpen && (<div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-end justify-center z-50" onClick={(e) => e.target === e.currentTarget && setIsModalOpen(false)}><div className="bg-white w-full max-w-lg rounded-t-3xl p-6 pb-safe animate-in slide-in-from-bottom duration-200 overflow-y-auto max-h-[90vh]"><h3 className="text-xl font-bold mb-4 text-stone-800 japanese-font">æ–°å¢è¡Œç¨‹</h3><div className="space-y-3"><div className="flex gap-3"><input type="time" value={newActivity.time} onChange={e=>setNewActivity({...newActivity, time:e.target.value})} className="bg-stone-50 p-3 rounded-xl border-none w-1/3 font-mono text-center font-bold text-lg outline-none focus:ring-2 focus:ring-rose-500" /><select value={newActivity.type} onChange={e=>setNewActivity({...newActivity, type:e.target.value})} className="bg-stone-50 p-3 rounded-xl border-none flex-1 font-bold text-stone-600 outline-none focus:ring-2 focus:ring-rose-500">{Object.entries(ACTIVITY_TYPES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select></div><input type="text" placeholder="æ¨™é¡Œ" value={newActivity.title} onChange={e=>setNewActivity({...newActivity, title:e.target.value})} className="w-full p-4 bg-stone-50 rounded-xl font-bold text-lg outline-none placeholder-stone-300 focus:ring-2 focus:ring-rose-500" autoFocus /><input type="text" placeholder="åœ°é» (å°èˆªç”¨)" value={newActivity.location} onChange={e=>setNewActivity({...newActivity, location:e.target.value})} className="w-full p-4 bg-stone-50 rounded-xl text-stone-600 outline-none placeholder-stone-300 focus:ring-2 focus:ring-rose-500" /><button onClick={handleAddActivity} className="w-full py-4 btn-sakura text-white rounded-xl font-bold text-lg shadow-lg hover:opacity-90">åŠ å…¥</button></div></div></div>)}

                  {/* Other Modals */}
                  <MapImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImport={handleImportMapList} currentTrip={currentTrip} tripDuration={currentTrip.days.length} />
                  <FlightDetailModal isOpen={isFlightModalOpen} onClose={() => setIsFlightModalOpen(false)} currentTrip={currentTrip} onUpdateTrip={handleUpdateTrip} />
                  <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} />
                  
                  {/* Draggable Map Window */}
                  {activeMapLocation && <DraggableMapWindow location={activeMapLocation} onClose={() => setActiveMapLocation(null)} />}
                  
                  {showCopyToast && <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-stone-800 text-white px-4 py-2 rounded-full shadow-lg z-50 flex items-center gap-2 animate-in fade-in slide-in-from-top-4"><Check size={16} className="text-green-400" /> è¡Œç¨‹å·²è¤‡è£½</div>}
              </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TravelPlanner />);
    </script>
</body>
</html>
