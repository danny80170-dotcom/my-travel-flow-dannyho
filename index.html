<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelFlow AI</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TravelFlow">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/826/826070.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        html { height: 100%; overflow: hidden; }
        body { 
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Inter', sans-serif; 
            background-color: #fffbf0; 
            position: fixed; overflow: hidden; 
            touch-action: pan-y; -webkit-user-select: none; user-select: none;
        }
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; position: relative; z-index: 1; }
        input, textarea { -webkit-user-select: text; user-select: text; }
        .scrolling-touch { -webkit-overflow-scrolling: touch; }
        h1, h2, h3, .japanese-font { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .btn-sakura { background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%); }
        .weather-card-gradient { background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.6) 100%); }
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose strong { color: #e11d48; font-weight: 700; }
        
        .petal { position: fixed; top: -10px; background-color: #ffd7e6; border-radius: 100% 0 100% 0; opacity: 0.8; z-index: 0; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { 0% { transform: translate(0, 0) rotate(0deg); opacity: 0; } 10% { opacity: 0.9; } 90% { opacity: 0.5; } 100% { transform: translate(100px, 100vh) rotate(720deg); opacity: 0; } }
        
        .float-anim { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .map-window-shadow { box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); }
        .guide-content { animation: expandHeight 0.3s ease-out; }
        @keyframes expandHeight { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-display" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:9999;padding:20px;color:red;"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-display').innerHTML = `<h3>âš ï¸ Error</h3><p>${message}</p>`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Map as MapIcon, Calendar, Clock, Plus, Trash2, MapPin, Bed, Plane, ChevronLeft, Save, 
            X, Sun, Utensils, Camera, Bus, Copy, Check, Sparkles, Loader2, ListPlus, 
            Lightbulb, CloudSun, Phone, Wallet, Car, Navigation, LayoutGrid, Settings, Key,
            UserCheck, UtensilsCrossed, CloudRain, Image as ImageIcon, Move, Droplets, Cloud, 
            CloudLightning, Wind, MessageCircle, Send, Bot, RefreshCw, ArrowLeft, ArrowRight,
            HelpCircle, Link, Upload, ImagePlus, Pencil, Building, ExternalLink, Hourglass, Info
        } from 'https://esm.sh/lucide-react@latest?deps=react@18.2.0';

        const apiKey = ""; 
        const generateId = () => Date.now() + Math.random();

        const DEFAULT_TRIPS = [
          {
            id: 1715432000000, title: "ğŸ‡¯ğŸ‡µ æ²–ç¹©è‡ªé§•æ¼«éŠ", startDate: "2025-06-15",
            arrival: { time: "10:00", location: "é‚£éœ¸æ©Ÿå ´ OKA" }, departure: { time: "17:00", location: "é‚£éœ¸æ©Ÿå ´ OKA" },
            transport: { type: "car", pickupTime: "11:30" },
            expenses: [], emergencyContacts: [],
            days: [
              { id: 1715432000001, date: "Day 1", hotel: "Vessel Hotel Campana", weather: "sunny", activities: [ { id: 101, time: "11:30", type: "transport", title: "å–è»Š", location: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€", note: "æª¢æŸ¥è»Šæ³", duration: "1å°æ™‚" }, { id: 102, time: "13:00", type: "food", title: "å¹¸ç¦é¬†é¤…", location: "å¹¸ç¦é¬†é¤… ç€¨é•·å³¶åº—", note: "éœ€é ç´„", duration: "1.5å°æ™‚" } ] }
            ]
          }
        ];

        const ACTIVITY_TYPES = {
          sightseeing: { label: "æ™¯é»", icon: Camera, color: "text-rose-700 bg-rose-50 border-rose-200" }, 
          food: { label: "ç¾é£Ÿ", icon: Utensils, color: "text-amber-700 bg-amber-50 border-amber-200" }, 
          transport: { label: "äº¤é€š", icon: Car, color: "text-stone-600 bg-stone-100 border-stone-300" }, 
          accommodation: { label: "ä½å®¿", icon: Bed, color: "text-emerald-700 bg-emerald-50 border-emerald-200" }, 
          shopping: { label: "è³¼ç‰©", icon: MapPin, color: "text-indigo-700 bg-indigo-50 border-indigo-200" }, 
          other: { label: "å…¶ä»–", icon: MapPin, color: "text-gray-600 bg-gray-50 border-gray-200" },
        };

        const calculateDate = (startDate, dayIndex) => {
            if (!startDate) return "";
            try {
                const parts = startDate.split('-');
                if (parts.length !== 3) return ""; 
                const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                d.setDate(d.getDate() + dayIndex); 
                return `${d.getMonth() + 1}/${d.getDate()} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
            } catch (e) { return ""; }
        };

        async function callGemini(contentParts, responseMimeType = "application/json") {
          try {
            const userApiKey = localStorage.getItem('travel_flow_api_key');
            const effectiveApiKey = apiKey || userApiKey || "";
            const parts = typeof contentParts === 'string' ? [{ text: contentParts }] : contentParts;
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveApiKey}`, { 
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: { responseMimeType: responseMimeType } }) 
            });
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            return responseMimeType === "application/json" && text ? JSON.parse(text) : text;
          } catch (error) { throw error; }
        }

        // --- Visual Components ---
        const SakuraBackground = () => {
            const containerRef = useRef(null);
            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;
                const createPetal = () => {
                    const petal = document.createElement('div');
                    petal.classList.add('petal');
                    const size = Math.random() * 10 + 8 + 'px';
                    const left = Math.random() * 100 + 'vw';
                    const duration = Math.random() * 5 + 6 + 's';
                    const delay = Math.random() * 5 + 's';
                    petal.style.width = size;
                    petal.style.height = size;
                    petal.style.left = left;
                    petal.style.animationDuration = duration;
                    petal.style.animationDelay = delay;
                    container.appendChild(petal);
                    setTimeout(() => { if(petal && container.contains(petal)) container.removeChild(petal); }, 12000); 
                };
                const interval = setInterval(createPetal, 800);
                for(let i=0; i<5; i++) createPetal();
                return () => clearInterval(interval);
            }, []);
            return <div ref={containerRef} className="fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>;
        };

        const JapaneseDecoration = () => (
            <div className="fixed bottom-0 right-0 opacity-20 pointer-events-none z-0">
                <svg width="250" height="200" viewBox="0 0 300 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M60 180 L60 80 M160 180 L160 80" stroke="#e11d48" strokeWidth="8" strokeLinecap="round"/>
                    <path d="M40 80 L180 80" stroke="#e11d48" strokeWidth="8" strokeLinecap="round"/>
                    <path d="M50 100 L170 100" stroke="#e11d48" strokeWidth="6" strokeLinecap="round"/>
                    <g className="float-anim" style={{transformBox: 'fill-box', transformOrigin: 'center'}}>
                        <path d="M220 180 C190 180 190 130 220 120 C250 130 250 180 220 180 Z" fill="#94a3b8" />
                        <path d="M205 180 L210 185 M235 180 L230 185" stroke="#94a3b8" strokeWidth="4" strokeLinecap="round"/>
                        <circle cx="210" cy="115" r="5" fill="#94a3b8"/>
                        <circle cx="230" cy="115" r="5" fill="#94a3b8"/>
                        <circle cx="260" cy="160" r="8" fill="#1e293b" />
                        <circle cx="257" cy="158" r="2" fill="white" />
                        <circle cx="263" cy="158" r="2" fill="white" />
                        <circle cx="180" cy="170" r="6" fill="#1e293b" />
                        <circle cx="178" cy="169" r="1.5" fill="white" />
                        <circle cx="182" cy="169" r="1.5" fill="white" />
                    </g>
                </svg>
            </div>
        );

        // --- Trip Info View (NEW) ---
        function TripInfoView({ trip, onUpdate }) {
            const [newExpense, setNewExpense] = useState({ title: "", amount: "", currency: "JPY" });
            const [newContact, setNewContact] = useState({ name: "", phone: "" });
            
            const totalExpense = (trip.expenses || []).reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
            
            const addExpense = () => {
                if (!newExpense.title || !newExpense.amount) return;
                const updatedExpenses = [...(trip.expenses || []), { ...newExpense, id: generateId(), amount: Number(newExpense.amount) }];
                onUpdate(trip.id, { expenses: updatedExpenses });
                setNewExpense({ title: "", amount: "", currency: "JPY" });
            };
            
            const deleteExpense = (id) => onUpdate(trip.id, { expenses: trip.expenses.filter(e => e.id !== id) });
            
            const addContact = () => {
                if (!newContact.name || !newContact.phone) return;
                const updatedContacts = [...(trip.emergencyContacts || []), { ...newContact, id: generateId() }];
                onUpdate(trip.id, { emergencyContacts: updatedContacts });
                setNewContact({ name: "", phone: "" });
            };
            
            const deleteContact = (id) => onUpdate(trip.id, { emergencyContacts: trip.emergencyContacts.filter(c => c.id !== id) });

            return (
                <div className="p-4 space-y-4 pb-24 overflow-y-auto h-full">
                    {/* Flight & Transport */}
                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-stone-200">
                        <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Plane size={20} className="text-blue-500"/> èˆªç­ & äº¤é€š</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                <span className="text-xs text-blue-400 font-bold block mb-1">æŠµé”</span>
                                <div className="text-lg font-bold text-stone-800">{trip.arrival?.time || "--:--"}</div>
                                <div className="text-xs text-stone-500 truncate">{trip.arrival?.location || "æœªè¨­å®š"}</div>
                            </div>
                            <div className="bg-orange-50 p-3 rounded-xl border border-orange-100">
                                <span className="text-xs text-orange-400 font-bold block mb-1">é›¢é–‹</span>
                                <div className="text-lg font-bold text-stone-800">{trip.departure?.time || "--:--"}</div>
                                <div className="text-xs text-stone-500 truncate">{trip.departure?.location || "æœªè¨­å®š"}</div>
                            </div>
                        </div>
                        {trip.transport?.type === 'car' ? (
                            <div className="bg-stone-50 p-3 rounded-xl border border-stone-200 flex items-center gap-3">
                                <div className="p-2 bg-white rounded-full border border-stone-100"><Car size={18} className="text-stone-600"/></div>
                                <div>
                                    <span className="text-xs font-bold text-stone-400 block">ç§Ÿè»Šè‡ªé§•</span>
                                    <span className="text-sm font-bold text-stone-800">å–è»Š: {trip.transport.pickupTime || "--:--"}</span>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-stone-50 p-3 rounded-xl border border-stone-200 flex items-center gap-3">
                                <div className="p-2 bg-white rounded-full border border-stone-100"><Bus size={18} className="text-stone-600"/></div>
                                <span className="text-sm font-bold text-stone-600">æ­ä¹˜å¤§çœ¾é‹è¼¸</span>
                            </div>
                        )}
                    </div>

                    {/* Hotel List */}
                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-stone-200">
                        <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Bed size={20} className="text-emerald-500"/> ä½å®¿æ¸…å–®</h3>
                        <div className="space-y-3">
                            {trip.days.slice(0, trip.days.length - 1).map((day, idx) => (
                                <div key={day.id} className="flex items-center gap-3 border-b border-stone-50 last:border-0 pb-2 last:pb-0">
                                    <span className="text-xs font-mono font-bold text-stone-400 w-12">Day {idx+1}</span>
                                    <div className="flex-1">
                                        <div className="text-sm font-bold text-stone-800">{day.hotel || "æœªè¨­å®šä½å®¿"}</div>
                                        <div className="text-xs text-stone-400">{calculateDate(trip.startDate, idx)}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Expenses */}
                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-stone-200">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-stone-800 flex items-center gap-2"><Wallet size={20} className="text-rose-500"/> é ç®—è¨˜å¸³</h3><span className="text-xs bg-rose-50 text-rose-600 px-2 py-1 rounded-full font-bold">Â¥{totalExpense.toLocaleString()}</span></div>
                        <div className="flex gap-2 mb-3"><input type="text" placeholder="é …ç›®" value={newExpense.title} onChange={e=>setNewExpense({...newExpense, title:e.target.value})} className="flex-1 p-2 bg-stone-50 rounded-lg text-xs outline-none" /><input type="number" placeholder="é‡‘é¡" value={newExpense.amount} onChange={e=>setNewExpense({...newExpense, amount:e.target.value})} className="w-20 p-2 bg-stone-50 rounded-lg text-xs outline-none" /><button onClick={addExpense} className="p-2 bg-stone-100 rounded-lg text-stone-500 hover:bg-stone-200"><Plus size={16}/></button></div>
                        <div className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">{trip.expenses?.map(exp => (<div key={exp.id} className="flex justify-between items-center text-sm p-2 hover:bg-stone-50 rounded-lg"><span>{exp.title}</span><div className="flex items-center gap-2"><span className="font-mono font-bold">Â¥{exp.amount}</span><button onClick={()=>deleteExpense(exp.id)} className="text-stone-300 hover:text-red-400"><X size={14}/></button></div></div>))}</div>
                    </div>

                    {/* Emergency Contacts */}
                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-stone-200">
                        <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Phone size={20} className="text-orange-500"/> ç·Šæ€¥è¯çµ¡</h3>
                        <div className="flex gap-2 mb-3"><input type="text" placeholder="åç¨±" value={newContact.name} onChange={e=>setNewContact({...newContact, name:e.target.value})} className="flex-1 p-2 bg-stone-50 rounded-lg text-xs outline-none" /><input type="tel" placeholder="é›»è©±" value={newContact.phone} onChange={e=>setNewContact({...newContact, phone:e.target.value})} className="flex-1 p-2 bg-stone-50 rounded-lg text-xs outline-none" /><button onClick={addContact} className="p-2 bg-stone-100 rounded-lg text-stone-500 hover:bg-stone-200"><Plus size={16}/></button></div>
                        <div className="space-y-2">{trip.emergencyContacts?.map(c => (<div key={c.id} className="flex justify-between items-center bg-red-50 p-3 rounded-xl border border-red-100"><div><div className="text-xs text-red-400 font-bold">{c.name}</div><div className="text-red-800 font-mono font-bold select-all">{c.phone}</div></div><button onClick={()=>deleteContact(c.id)} className="text-red-300 hover:text-red-600"><X size={16}/></button></div>))}</div>
                    </div>
                </div>
            );
        }

        // --- Other Components (DashboardWeather, DraggableMapWindow, ActivityGuide, ActivityItem) ---
        function DashboardWeather({ locationName }) {
            const [weather, setWeather] = useState(null);
            const [city, setCity] = useState("Loading...");
            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        let query = locationName || "Taipei";
                        query = query.replace(/[^\u4e00-\u9fa5a-zA-Z\s]/g, "").replace(/(ä¹‹æ—…|è‡ªç”±è¡Œ|è‡ªé§•|æ¼«éŠ|è¡Œç¨‹|äº”å¤©å››å¤œ|å…­å¤©äº”å¤œ|Day|day)/g, "").trim().substring(0, 15);
                        if (!query) query = "Taipei";
                        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=zh&format=json`);
                        const geoData = await geoRes.json();
                        if (geoData.results && geoData.results.length > 0) {
                            const { latitude, longitude, name } = geoData.results[0];
                            setCity(name);
                            const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,precipitation_probability_max&current_weather=true&timezone=auto`);
                            setWeather(await weatherRes.json());
                        } else { setCity("æœªçŸ¥åœ°é»"); setWeather(null); }
                    } catch (e) { setCity("å¤©æ°£è¼‰å…¥å¤±æ•—"); }
                };
                fetchWeather();
            }, [locationName]);
            if(!weather) return <div className="mx-4 mb-6 h-32 rounded-3xl bg-stone-200 animate-pulse flex items-center justify-center text-stone-400 text-sm">æ­£åœ¨å°‹æ‰¾ {locationName} çš„å¤©æ°£...</div>;
            const getWeatherIcon = (code) => { if (code === 0) return <Sun className="text-orange-500" size={16} />; if (code <= 3) return <CloudSun className="text-yellow-500" size={16} />; if (code <= 67) return <CloudRain className="text-blue-500" size={16} />; return <Cloud className="text-gray-400" size={16} />; };
            return <div className="mx-4 mb-6 rounded-3xl p-6 weather-card-gradient shadow-lg border border-white/40 relative z-10 flex justify-between items-center"><div><h2 className="text-3xl font-bold text-stone-800 japanese-font">{Math.round(weather.current_weather.temperature)}Â°</h2><p className="text-stone-500 text-sm font-bold flex items-center gap-1"><MapPin size={12}/> {city}</p></div><div className="flex gap-3 overflow-x-auto no-scrollbar pb-1">{weather.daily.time.slice(0,5).map((t,i) => (<div key={t} className="flex flex-col items-center min-w-[40px]"><span className="text-[10px] text-stone-400 font-bold mb-1">{new Date(t).getDate()}æ—¥</span>{getWeatherIcon(weather.daily.weathercode[i])}<span className="text-xs text-stone-600 font-bold mt-1">{Math.round(weather.daily.temperature_2m_max[i])}Â°</span><span className="text-[10px] text-blue-500 font-bold">{weather.daily.precipitation_probability_max[i]}%</span></div>))}</div></div>;
        }

        function DraggableMapWindow({ location, onClose }) {
            const [position, setPosition] = useState({ x: 20, y: 150 }); 
            const [isDragging, setIsDragging] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const windowRef = useRef(null);
            const handleStart = (clientX, clientY) => { if (windowRef.current) { setIsDragging(true); const rect = windowRef.current.getBoundingClientRect(); setDragOffset({ x: clientX - rect.left, y: clientY - rect.top }); } };
            const onMouseDown = (e) => handleStart(e.clientX, e.clientY);
            const onTouchStart = (e) => handleStart(e.touches[0].clientX, e.touches[0].clientY);
            useEffect(() => { const handleMove = (clientX, clientY) => { if (isDragging) { const newX = Math.max(0, Math.min(window.innerWidth - 300, clientX - dragOffset.x)); const newY = Math.max(0, Math.min(window.innerHeight - 300, clientY - dragOffset.y)); setPosition({ x: newX, y: newY }); } }; const onMouseMove = (e) => handleMove(e.clientX, e.clientY); const onTouchMove = (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY); const onEnd = () => setIsDragging(false); if (isDragging) { window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onEnd); window.addEventListener('touchmove', onTouchMove, { passive: false }); window.addEventListener('touchend', onEnd); } return () => { window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onEnd); window.removeEventListener('touchmove', onTouchMove); window.removeEventListener('touchend', onEnd); }; }, [isDragging, dragOffset]);
            return <div ref={windowRef} className="fixed z-50 w-80 bg-white rounded-2xl overflow-hidden border border-stone-200 map-window-shadow animate-in zoom-in-95 duration-200" style={{ left: position.x, top: position.y }}><div className="bg-stone-800 text-white px-3 py-2 flex justify-between items-center cursor-move touch-none" onMouseDown={onMouseDown} onTouchStart={onTouchStart}><div className="flex items-center gap-2 text-sm font-bold truncate"><Move size={14} className="opacity-50"/> <span className="truncate max-w-[200px]">{location}</span></div><button onClick={onClose} className="p-1 hover:bg-stone-600 rounded-full transition-colors"><X size={16} /></button></div><div className="h-64 bg-stone-100 relative"><iframe width="100%" height="100%" frameBorder="0" src={`https://maps.google.com/maps?q=${encodeURIComponent(location)}&t=&z=15&ie=UTF8&iwloc=&output=embed`} style={{ border: 0 }} allowFullScreen></iframe>{isDragging && <div className="absolute inset-0 bg-transparent z-10"></div>}</div><div className="p-2 bg-stone-50 flex justify-between items-center text-xs text-stone-500"><span>é•·æŒ‰æ¨™é¡Œåˆ—å¯æ‹–æ›³</span><a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location)}&travelmode=driving`} target="_blank" className="flex items-center gap-1 text-blue-600 font-bold px-2 py-1 hover:bg-blue-50 rounded"><Navigation size={12}/> é–‹å•Ÿå°èˆª</a></div></div>;
        }

        function ActivityGuide({ activity }) {
            const [info, setInfo] = useState(null);
            const [loading, setLoading] = useState(false);
            const [show, setShow] = useState(false);
            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(activity.location + " " + activity.title + " scenery Japan travel")}`;
            const fetchGuideInfo = async () => { if (info) { setShow(!show); return; } setLoading(true); setShow(true); const prompt = `ä»‹ç´¹åœ°é»ï¼šã€Œ${activity.title} (${activity.location})ã€ã€‚è«‹å›å‚³åš´æ ¼çš„ JSON æ ¼å¼ (ä¸è¦æœ‰ markdown code block)ï¼š{ "intro": "ç´„150å­—ä»‹ç´¹ï¼ŒåŒ…å«æ­·å²æˆ–ç‰¹è‰²ã€‚", "highlight": "å¿…çœ‹äº®é»æˆ– Pro Tips", "food": "æ¨è–¦ç¾é£Ÿæˆ–ä¼´æ‰‹ç¦®" }`; try { const res = await callGemini(prompt, "application/json"); setInfo(res); } catch (e) { setInfo({ intro: "å°éŠæš«æ™‚ç„¡æ³•é€£ç·šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", highlight: "", food: "" }); } finally { setLoading(false); } };
            return <div className="mt-3"><button onClick={fetchGuideInfo} className={`text-xs font-bold flex items-center gap-1 px-3 py-1.5 rounded-full transition-colors ${show ? 'bg-amber-100 text-amber-700' : 'bg-stone-100 text-stone-500 hover:bg-amber-50 hover:text-amber-600'}`}><UserCheck size={14} /> {show ? "æ”¶èµ·å°éŠ" : "å°éŠä»‹ç´¹"}</button>{show && (<div className="mt-3 bg-[#fffbf0] rounded-xl border border-amber-100 overflow-hidden guide-content"><div className="h-32 w-full bg-stone-200 relative overflow-hidden group"><img src={imageUrl} alt={activity.title} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} /><a href={`https://www.google.com/search?q=${encodeURIComponent(activity.title + " " + activity.location)}`} target="_blank" className="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded-full flex items-center gap-1 hover:bg-black/80 backdrop-blur-sm"><ExternalLink size={10} /> æœå°‹æ›´å¤š</a></div><div className="p-4">{loading ? (<div className="flex justify-center py-4 text-amber-400"><Loader2 className="animate-spin" /></div>) : info ? (<div className="space-y-3 text-sm text-stone-700"><div><h5 className="font-bold text-amber-800 flex items-center gap-1 mb-1"><MapPin size={12}/> æ™¯é»æ•…äº‹</h5><p className="text-stone-600 leading-relaxed text-justify">{info.intro}</p></div>{info.highlight && <div className="bg-white p-2 rounded-lg border border-amber-100"><span className="text-xs font-bold text-rose-500 block">âœ¨ å°ˆæ¥­å»ºè­° (Pro Tips)</span><span className="text-xs text-stone-600">{info.highlight}</span></div>}{info.food && <div className="bg-white p-2 rounded-lg border border-amber-100"><span className="text-xs font-bold text-orange-500 block">ğŸ± ç¾é£Ÿ/ä¼´æ‰‹ç¦®</span><span className="text-xs text-stone-600">{info.food}</span></div>}</div>) : <div className="text-center text-xs text-red-400">è¼‰å…¥å¤±æ•—</div>}</div></div>)}</div>;
        }

        function ActivityItem({ activity, onUpdate, onDelete, onOpenMap }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editedActivity, setEditedActivity] = useState(activity);
            const typeConfig = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES.other;
            const handleSave = () => { onUpdate(editedActivity); setIsEditing(false); };
            if (isEditing) { return <div className="bg-white/95 p-4 rounded-xl shadow-lg border-2 border-rose-100 mb-4 animate-in fade-in relative z-20"><div className="space-y-3"><div className="flex gap-2"><input type="time" value={editedActivity.time} onChange={(e) => setEditedActivity({...editedActivity, time: e.target.value})} className="p-2 border border-stone-200 rounded-lg text-sm bg-stone-50 font-mono font-bold" /><select value={editedActivity.type} onChange={(e) => setEditedActivity({...editedActivity, type: e.target.value})} className="flex-1 p-2 border border-stone-200 rounded-lg text-sm bg-stone-50">{Object.entries(ACTIVITY_TYPES).map(([key, config]) => (<option key={key} value={key}>{config.label}</option>))}</select></div><input type="text" placeholder="æ¨™é¡Œ" value={editedActivity.title} onChange={(e) => setEditedActivity({...editedActivity, title: e.target.value})} className="w-full p-2 border border-stone-200 rounded-lg font-bold text-lg" /><input type="text" placeholder="å»ºè­°åœç•™æ™‚é–“ (å¦‚: 1.5å°æ™‚)" value={editedActivity.duration} onChange={(e) => setEditedActivity({...editedActivity, duration: e.target.value})} className="w-full p-2 border border-stone-200 rounded-lg text-sm" /><input type="text" placeholder="åœ°é»" value={editedActivity.location} onChange={(e) => setEditedActivity({...editedActivity, location: e.target.value})} className="w-full p-2 border border-stone-200 rounded-lg text-sm" /><textarea placeholder="å‚™è¨»" value={editedActivity.note} onChange={(e) => setEditedActivity({...editedActivity, note: e.target.value})} className="w-full p-2 border border-stone-200 rounded-lg text-sm h-16 resize-none"></textarea><div className="flex gap-2 justify-end"><button onClick={() => setIsEditing(false)} className="px-3 py-1.5 text-stone-500 hover:bg-stone-100 rounded-lg text-sm">å–æ¶ˆ</button><button onClick={handleSave} className="px-3 py-1.5 btn-sakura text-white rounded-lg text-sm shadow-sm">å„²å­˜</button></div></div></div>; }
            return <div className="relative pl-8 pb-8 group last:pb-0 z-10"><div className="absolute left-[11px] top-6 bottom-0 w-0.5 bg-stone-200 group-last:hidden"></div><div className={`absolute left-[3px] top-6 w-5 h-5 rounded-full border-4 border-[#fffbf0] z-10 ${typeConfig.color.split(' ')[1]} shadow-sm`}></div><div className="bg-white rounded-2xl p-4 shadow-sm border border-stone-100 hover:shadow-md transition-all relative group-hover:border-stone-200 cursor-default"><div className="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => setIsEditing(true)} className="p-1.5 text-stone-400 hover:text-rose-500 rounded-full hover:bg-rose-50"><Pencil size={14} /></button><button onClick={() => onDelete(activity.id)} className="p-1.5 text-stone-400 hover:text-red-500 rounded-full hover:bg-red-50"><Trash2 size={14} /></button></div><div className="flex justify-between items-start mb-2 pr-12"><div><div className="flex items-center gap-2 mb-1.5"><span className="font-mono text-sm font-bold text-stone-400">{activity.time}</span><span className={`text-[10px] px-2 py-0.5 rounded-full ${typeConfig.color}`}>{typeConfig.label}</span>{activity.duration && <span className="flex items-center gap-0.5 text-[10px] text-stone-400 bg-stone-100 px-1.5 py-0.5 rounded-full"><Hourglass size={10}/> {activity.duration}</span>}</div><h3 className="font-bold text-stone-800 text-lg">{activity.title}</h3></div></div>{activity.location && (<div className="flex flex-col gap-2 mb-3"><div className="flex items-center gap-2"><div className="flex items-center gap-1 text-sm text-stone-500 truncate max-w-[200px]"><MapPin size={14} className="text-rose-400"/><span>{activity.location}</span></div><button onClick={() => window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(activity.location)}&travelmode=driving`, '_blank')} className="flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 rounded-full text-xs font-medium hover:bg-blue-100 transition-colors"><Navigation size={12} /> å°èˆª</button></div><button onClick={() => onOpenMap(activity.location)} className="flex items-center gap-1 text-xs font-bold text-stone-400 hover:text-rose-500 transition-colors self-start ml-5"><MapIcon size={12} /> é è¦½åœ°åœ–</button></div>)}{activity.note && <div className="text-sm text-stone-600 bg-stone-50 p-3 rounded-lg border border-stone-100 mb-2"><p className="whitespace-pre-wrap">{activity.note}</p></div>}<ActivityGuide activity={activity} /></div></div>;
        }

        // --- CreateTripWizard (Updates 1, 4, 5) ---
        function CreateTripWizard({ isOpen, onClose, onCreate }) {
            const [step, setStep] = useState(1);
            const [data, setData] = useState({ 
                title: "", date: new Date().toISOString().split('T')[0], days: 7, 
                arrival: { time: "10:00", location: "æ©Ÿå ´" },
                departure: { time: "16:00", location: "æ©Ÿå ´" },
                transport: { type: "public", pickupTime: "10:00" }, // Default
                hotels: [] 
            });
            const [isCreating, setIsCreating] = useState(false);
            const [sameHotel, setSameHotel] = useState(true);

            useEffect(() => { if (isOpen) { setStep(1); setData(prev => ({ ...prev, title: "", date: new Date().toISOString().split('T')[0], days: 7, useAI: true, hotels: [] })); setSameHotel(true); } }, [isOpen]);
            
            useEffect(() => {
                if (data.days > 0) {
                    setData(prev => {
                        const nights = Math.max(0, data.days - 1);
                        const newHotels = Array(nights).fill("").map((_, i) => prev.hotels[i] || "");
                        return { ...prev, hotels: newHotels };
                    });
                }
            }, [data.days]);

            const handleNext = () => { if (step < 4) setStep(step + 1); else handleSubmit(); };
            const handleBack = () => { if (step > 1) setStep(step - 1); };
            const handleHotelChange = (index, value) => { const newHotels = [...data.hotels]; newHotels[index] = value; if (sameHotel && index === 0) { setData({ ...data, hotels: Array(data.days - 1).fill(value) }); } else { setData({ ...data, hotels: newHotels }); } };
            const toggleSameHotel = () => { const isNowSame = !sameHotel; setSameHotel(isNowSame); if (isNowSame) { const firstHotel = data.hotels[0] || ""; setData({ ...data, hotels: Array(Math.max(0, data.days - 1)).fill(firstHotel) }); } };
            const handleSubmit = async () => { setIsCreating(true); await onCreate(data); setIsCreating(false); onClose(); };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-3xl w-full max-w-sm shadow-xl animate-in zoom-in relative overflow-hidden flex flex-col max-h-[85vh]">
                        <div className="absolute top-0 left-0 h-1 bg-stone-100 w-full"><div className="h-full bg-rose-500 transition-all duration-300" style={{width: `${(step/4)*100}%`}}></div></div>
                        <div className="mb-4 mt-2 flex-none"><h3 className="text-xl font-bold text-stone-800 japanese-font flex justify-between items-center">{step===1?"åŸºæœ¬è³‡è¨Š":step===2?"èˆªç­è³‡è¨Š":step===3?"äº¤é€šæ–¹å¼":"ä½å®¿å®‰æ’"}<span className="text-xs text-stone-400 font-sans">Step {step}/4</span></h3></div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-1">
                            {step === 1 && ( <div className="space-y-4 animate-in slide-in-from-right duration-200"><div><label className="text-xs font-bold text-stone-500">æ—…ç¨‹åç¨±</label><input type="text" placeholder="ä¾‹å¦‚ï¼šäº¬éƒ½äº”å¤©å››å¤œ" value={data.title} onChange={e=>setData({...data, title:e.target.value})} className="w-full p-3 bg-stone-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-500" autoFocus /></div><div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold text-stone-500">å‡ºç™¼æ—¥æœŸ</label><input type="date" value={data.date} onChange={e=>setData({...data, date:e.target.value})} className="w-full p-3 bg-stone-50 rounded-xl outline-none" /></div><div><label className="text-xs font-bold text-stone-500">å¤©æ•¸</label><input type="number" min="2" max="30" value={data.days} onChange={e=>setData({...data, days:parseInt(e.target.value)||1})} className="w-full p-3 bg-stone-50 rounded-xl outline-none" /></div></div><div onClick={() => setData({...data, useAI: !data.useAI})} className={`p-3 rounded-xl border flex items-center gap-2 cursor-pointer ${data.useAI ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-stone-200 text-stone-500'}`}><div className={`w-5 h-5 rounded border flex items-center justify-center ${data.useAI ? 'bg-indigo-600 border-indigo-600' : 'bg-white'}`}>{data.useAI && <Check size={14} className="text-white"/>}</div><span className="text-sm font-bold flex items-center gap-1"><Sparkles size={14}/> AI è‡ªå‹•è¦åŠƒ</span></div></div> )}
                            {step === 2 && ( <div className="space-y-4 animate-in slide-in-from-right duration-200"><div className="p-3 bg-blue-50 rounded-xl border border-blue-100"><h4 className="font-bold text-blue-800 text-sm mb-2 flex items-center gap-1"><Plane size={14} className="rotate-90"/> å»ç¨‹è³‡è¨Š (Day 1)</h4><div className="flex gap-2"><input type="time" value={data.arrival.time} onChange={e=>setData({...data, arrival:{...data.arrival, time:e.target.value}})} className="w-24 p-2 bg-white rounded-lg text-sm outline-none" /><input type="text" placeholder="æŠµé”æ©Ÿå ´/åœ°é»" value={data.arrival.location} onChange={e=>setData({...data, arrival:{...data.arrival, location:e.target.value}})} className="flex-1 p-2 bg-white rounded-lg text-sm outline-none" /></div></div><div className="p-3 bg-orange-50 rounded-xl border border-orange-100"><h4 className="font-bold text-orange-800 text-sm mb-2 flex items-center gap-1"><Plane size={14}/> å›ç¨‹è³‡è¨Š (Day {data.days})</h4><div className="flex gap-2"><input type="time" value={data.departure.time} onChange={e=>setData({...data, departure:{...data.departure, time:e.target.value}})} className="w-24 p-2 bg-white rounded-lg text-sm outline-none" /><input type="text" placeholder="å‡ºç™¼æ©Ÿå ´/åœ°é»" value={data.departure.location} onChange={e=>setData({...data, departure:{...data.departure, location:e.target.value}})} className="flex-1 p-2 bg-white rounded-lg text-sm outline-none" /></div></div></div> )}
                            {step === 3 && (
                                <div className="space-y-4 animate-in slide-in-from-right duration-200">
                                    <p className="text-sm text-stone-500">æ‚¨é€™æ¬¡æ—…ç¨‹ä¸»è¦çš„äº¤é€šæ–¹å¼æ˜¯ï¼Ÿ</p>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => setData({...data, transport: { ...data.transport, type: 'public' }})} className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${data.transport.type === 'public' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-stone-100 bg-white text-stone-400'}`}><Bus size={24}/><span className="text-sm font-bold">å¤§çœ¾é‹è¼¸</span></button>
                                        <button onClick={() => setData({...data, transport: { ...data.transport, type: 'car' }})} className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${data.transport.type === 'car' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-stone-100 bg-white text-stone-400'}`}><Car size={24}/><span className="text-sm font-bold">ç§Ÿè»Šè‡ªé§•</span></button>
                                    </div>
                                    {data.transport.type === 'car' && (
                                        <div className="bg-stone-50 p-3 rounded-xl border border-stone-200 animate-in fade-in">
                                            <label className="text-xs font-bold text-stone-500 block mb-1">é è¨ˆå–è»Šæ™‚é–“ (Day 1)</label>
                                            <input type="time" value={data.transport.pickupTime} onChange={e=>setData({...data, transport: {...data.transport, pickupTime: e.target.value}})} className="w-full p-2 bg-white rounded-lg text-sm outline-none font-bold" />
                                        </div>
                                    )}
                                </div>
                            )}
                            {step === 4 && ( <div className="space-y-4 animate-in slide-in-from-right duration-200"><div className="flex justify-between items-center mb-2"><p className="text-sm text-stone-500">ä½å®¿è¨­å®š ({Math.max(0, data.days - 1)} æ™š)</p><button onClick={toggleSameHotel} className={`text-xs px-2 py-1 rounded-full border transition-colors ${sameHotel ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-stone-100 text-stone-500 border-stone-200'}`}>{sameHotel ? "å…¨ç¨‹åŒä¸€é–“" : "æ¯æ—¥ä¸åŒ"}</button></div>{sameHotel ? (<div><label className="text-xs font-bold text-stone-500">ä½å®¿é£¯åº—/å€åŸŸ</label><input type="text" placeholder="ä¾‹å¦‚ï¼šæ–°å®¿æ ¼æ‹‰æ–¯éº—é£¯åº—" value={data.hotels[0] || ""} onChange={e=>handleHotelChange(0, e.target.value)} className="w-full p-4 bg-stone-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-500 text-lg font-bold mt-1" autoFocus /></div>) : (<div className="space-y-3 pb-2">{Array.from({length: Math.max(0, data.days - 1)}).map((_, idx) => (<div key={idx} className="flex items-center gap-2"><span className="text-xs font-mono text-stone-400 w-16 flex-shrink-0">Night {idx+1}</span><input type="text" placeholder={`ç¬¬ ${idx+1} æ™šä½å®¿`} value={data.hotels[idx] || ""} onChange={e=>handleHotelChange(idx, e.target.value)} className="flex-1 p-3 bg-stone-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-500 text-sm" /></div>))}</div>)}</div> )}
                        </div>
                        <div className="flex justify-between gap-2 mt-4 pt-2 border-t border-stone-100 flex-none"><button onClick={step === 1 ? onClose : handleBack} className="px-4 py-3 text-stone-400 font-bold hover:bg-stone-50 rounded-xl">{step === 1 ? "å–æ¶ˆ" : "ä¸Šä¸€æ­¥"}</button><button onClick={handleNext} disabled={!data.title || isCreating} className="flex-1 py-3 btn-sakura text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">{isCreating ? <Loader2 className="animate-spin" /> : step === 4 ? (data.useAI ? "é–‹å§‹ AI è¦åŠƒ" : "å»ºç«‹è¡Œç¨‹") : "ä¸‹ä¸€æ­¥"}{!isCreating && step < 4 && <ArrowRight size={16}/>}</button></div>
                    </div>
                </div>
            );
        }

        // --- Main TravelPlanner Component ---
        function TravelPlanner() {
          const [trips, setTrips] = useState(() => JSON.parse(localStorage.getItem('travel_planner_trips')) || DEFAULT_TRIPS);
          const [currentTripId, setCurrentTripId] = useState(null);
          const [currentDayIndex, setCurrentDayIndex] = useState(0);
          const [activeTab, setActiveTab] = useState('itinerary'); // 'itinerary' or 'info'
          
          const [isChatOpen, setIsChatOpen] = useState(false);
          const [isImportModalOpen, setIsImportModalOpen] = useState(false);
          const [isCreateOpen, setIsCreateOpen] = useState(false);
          const [isAddActivityOpen, setIsAddActivityOpen] = useState(false); 
          const [activeMapLocation, setActiveMapLocation] = useState(null); 
          const [newActivity, setNewActivity] = useState({ time: "09:00", title: "", type: "sightseeing", location: "", note: "" });

          useEffect(() => { localStorage.setItem('travel_planner_trips', JSON.stringify(trips)); }, [trips]);

          const currentTrip = trips.find(t => t.id === currentTripId);
          const currentDay = currentTrip ? currentTrip.days[currentDayIndex] : null;

          const handleUpdateTrip = (id, data) => setTrips(trips.map(t => t.id === id ? { ...t, ...data } : t));
          const handleDeleteTrip = (id) => { if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) setTrips(trips.filter(t => t.id !== id)); setCurrentTripId(null); };

          const handleCreateTripSubmit = async (data) => {
              try {
                  let generatedDays = [];
                  if (data.useAI) {
                      const hotelsContext = data.hotels.map((h, i) => `Night ${i+1}: ${h}`).join(', ');
                      // AI Prompt updated with transportation logic
                      const transportPrompt = data.transport.type === 'car' ? `äº¤é€šæ–¹å¼ï¼šç§Ÿè»Šè‡ªé§•ã€‚è«‹åœ¨ Day 1 æŠµé”å¾Œå®‰æ’ã€Œå–è»Šã€è¡Œç¨‹ (é è¨ˆå–è»Šæ™‚é–“: ${data.transport.pickupTime})ã€‚` : `äº¤é€šæ–¹å¼ï¼šå¤§çœ¾é‹è¼¸ã€‚`;
                      const prompt = `è«‹ç‚ºæˆ‘è¦åŠƒã€Œ${data.title}ã€ã€‚å‡ºç™¼æ—¥æœŸï¼š${data.date}ã€‚å¤©æ•¸ï¼š${data.days}å¤©ã€‚
                      é‡è¦é™åˆ¶ï¼š
                      1. Day 1: èµ·é»æ˜¯ ${data.arrival.time} æŠµé” ${data.arrival.location}ã€‚è«‹åŠ ä¸Šå…¥å¢ƒæ™‚é–“ 1.5 å°æ™‚å¾Œé–‹å§‹è¡Œç¨‹ã€‚${transportPrompt}
                      2. Day ${data.days}: çµ‚é»æ˜¯ ${data.departure.time} æ–¼ ${data.departure.location}ã€‚
                      3. ä½å®¿å®‰æ’ï¼š${hotelsContext}ã€‚è¡Œç¨‹è«‹å‹™å¿…é…åˆç•¶å¤©ä½å®¿åœ°é»å®‰æ’ï¼Œç¢ºä¿é †è·¯ã€‚
                      4. æ¯å€‹è¡Œç¨‹è«‹æä¾› "duration" (å»ºè­°åœç•™æ™‚é–“ï¼Œå¦‚ "2å°æ™‚")ã€‚
                      è«‹å›å‚³ JSON: { "days": [ { "date": "Day 1", "activities": [ { "time": "10:00", "title": "...", "type": "sightseeing/food/shopping/transport", "location": "...", "note": "...", "duration": "..." } ] } ] }ã€‚`;
                      
                      const result = await callGemini(prompt);
                      if (result?.days) {
                          generatedDays = result.days.map((d, i) => ({
                              id: generateId(), date: d.date || `Day ${i+1}`, 
                              hotel: i < data.hotels.length ? data.hotels[i] : (i > 0 ? data.hotels[i-1] : ""), 
                              weather: "sunny",
                              activities: (d.activities || []).map(a => ({...a, id: generateId()}))
                          }));
                      }
                  } 
                  if (generatedDays.length === 0) {
                       generatedDays = Array.from({length: data.days}, (_, i) => ({ 
                           id: generateId(), 
                           date: `Day ${i+1}`, 
                           hotel: i < data.hotels.length ? data.hotels[i] : "", 
                           activities: [] 
                       }));
                  }
                  const newTrip = { 
                      id: generateId(), title: data.title, startDate: data.date, 
                      arrival: data.arrival, departure: data.departure, transport: data.transport, expenses: [], emergencyContacts: [], days: generatedDays
                  };
                  setTrips([...trips, newTrip]); 
              } catch (e) { alert("å»ºç«‹å¤±æ•—: " + e.message); }
          };

          const handleAddManualActivity = () => {
              if(!newActivity.title) return;
              const act = { ...newActivity, id: generateId() };
              const updatedDays = currentTrip.days.map((day, idx) => {
                  if (idx !== currentDayIndex) return day;
                  return { ...day, activities: [...day.activities, act].sort((a,b) => a.time.localeCompare(b.time)) };
              });
              handleUpdateTrip(currentTrip.id, { days: updatedDays });
              setIsAddActivityOpen(false);
              setNewActivity({ time: "09:00", title: "", type: "sightseeing", location: "", note: "" });
          };

          if (!currentTrip) {
              return (
                  <div className="h-[100dvh] w-full p-6 pb-24 overflow-y-auto relative z-10 scrolling-touch">
                      <SakuraBackground />
                      <JapaneseDecoration />
                      <DashboardWeather locationName="Taipei" />
                      <h1 className="text-2xl font-bold text-stone-800 px-4 mb-4 japanese-font flex items-center gap-2 relative z-10"><MapIcon className="text-rose-500"/> æˆ‘çš„æ—…ç¨‹</h1>
                      <div className="grid gap-4 px-4 relative z-10">
                          {trips.map(trip => (
                              <div key={trip.id} onClick={() => { setCurrentTripId(trip.id); setActiveTab('itinerary'); }} className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-stone-200 cursor-pointer hover:border-rose-300 transition-all">
                                  <h3 className="font-bold text-lg mb-1 japanese-font">{trip.title}</h3>
                                  <p className="text-sm text-stone-500">{trip.startDate} Â· {trip.days.length} å¤©</p>
                              </div>
                          ))}
                          <button onClick={() => setIsCreateOpen(true)} className="py-4 border-2 border-dashed border-stone-300 text-stone-400 rounded-2xl font-bold hover:border-rose-400 hover:text-rose-500 transition-colors flex items-center justify-center gap-2"><Plus/> å»ºç«‹æ–°æ—…ç¨‹</button>
                      </div>
                      <CreateTripWizard isOpen={isCreateOpen} onClose={() => setIsCreateOpen(false)} onCreate={handleCreateTripSubmit} />
                  </div>
              );
          }

          return (
              <div className="h-[100dvh] w-full flex flex-col font-sans text-stone-800 overflow-hidden relative bg-stone-50">
                  <SakuraBackground />
                  <header className="bg-white/90 backdrop-blur-sm px-4 py-3 border-b border-stone-200 flex justify-between items-center sticky top-0 z-30 shadow-sm flex-none">
                      <div className="flex items-center gap-3">
                          <button onClick={() => setCurrentTripId(null)} className="p-2 hover:bg-stone-50 rounded-full text-stone-500"><ChevronLeft/></button>
                          <div className="flex-1 overflow-hidden">
                              <h1 className="font-bold text-lg truncate japanese-font">{currentTrip.title}</h1>
                              <p className="text-xs text-stone-500 truncate">{currentTrip.startDate} å‡ºç™¼</p>
                          </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setIsImportModalOpen(true)} className="p-2 text-stone-500 hover:bg-stone-100 rounded-full"><ListPlus size={20}/></button>
                        <button onClick={() => setIsChatOpen(true)} className={`p-2 rounded-full transition-colors flex items-center gap-1 ${isChatOpen ? 'bg-indigo-100 text-indigo-600' : 'text-stone-500 hover:bg-stone-100'}`}>
                            <Bot size={20} /> <span className="hidden md:inline text-xs font-bold">AI åŠ©æ‰‹</span>
                        </button>
                      </div>
                  </header>

                  <div className="flex-1 relative flex overflow-hidden z-10 min-h-0">
                      {activeTab === 'itinerary' ? (
                          <div className="flex-1 flex flex-col h-full min-w-[320px] min-h-0">
                              <div className="pt-2"><DashboardWeather locationName={currentTrip.title} /></div>
                              <div className="flex overflow-x-auto p-2 gap-2 bg-white/50 backdrop-blur-sm border-b border-stone-200 no-scrollbar z-20 shadow-sm flex-none sticky top-0">
                                  {currentTrip.days.map((day, idx) => (
                                      <button key={day.id} onClick={() => setCurrentDayIndex(idx)} className={`flex-none px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all flex flex-col items-center ${currentDayIndex === idx ? 'btn-sakura text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}`}>
                                          <span>Day {idx + 1}</span>
                                          <span className="text-[10px] opacity-80">{calculateDate(currentTrip.startDate, idx).split(' ')[0]}</span>
                                      </button>
                                  ))}
                              </div>
                              <div className="flex-1 overflow-y-auto scrolling-touch p-4 pb-24 custom-scrollbar relative">
                                    <div className="mb-4 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex items-center gap-3 relative z-10">
                                        <div className="p-2 bg-emerald-50 rounded-full text-emerald-600"><Building size={20}/></div>
                                        <div><p className="text-xs text-stone-400 font-bold">Day {currentDayIndex+1} æ™šä¸Šä½å®¿</p><p className="font-bold text-stone-800">{currentTrip.days[currentDayIndex].hotel || (currentDayIndex < currentTrip.days.length -1 ? "å°šæœªè¨­å®š" : "æº–å‚™å›ç¨‹")}</p></div>
                                    </div>
                                    <div className="space-y-0">
                                        {(currentDay.activities || []).length === 0 ? <div className="text-center py-12 text-stone-400">å°šç„¡è¡Œç¨‹ï¼Œé»æ“Š + æ–°å¢</div> : 
                                          currentDay.activities.map(act => (
                                              <ActivityItem key={act.id} activity={act} onUpdate={(updatedAct) => { const updatedDays = [...currentTrip.days]; updatedDays[currentDayIndex].activities = updatedDays[currentDayIndex].activities.map(a => a.id === updatedAct.id ? updatedAct : a).sort((a,b) => a.time.localeCompare(b.time)); handleUpdateTrip(currentTrip.id, { days: updatedDays }); }} onDelete={(id) => { const updatedDays = [...currentTrip.days]; updatedDays[currentDayIndex].activities = updatedDays[currentDayIndex].activities.filter(a => a.id !== id); handleUpdateTrip(currentTrip.id, { days: updatedDays }); }} onOpenMap={setActiveMapLocation} />
                                          ))
                                        }
                                    </div>
                                    <div className="h-20"></div> 
                              </div>
                          </div>
                      ) : (
                          <div className="flex-1 overflow-y-auto h-full"><TripInfoView trip={currentTrip} onUpdate={handleUpdateTrip} /></div>
                      )}
                  </div>
                  
                  {/* Bottom Navigation */}
                  <nav className="bg-white/90 backdrop-blur-md border-t border-stone-200 px-6 py-2 flex justify-around items-center z-30 pb-safe flex-none">
                      <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeTab === 'itinerary' ? 'text-rose-600' : 'text-stone-400'}`}><MapIcon size={24} strokeWidth={activeTab==='itinerary'?2.5:2} /><span className="text-[10px] font-bold">è¡Œç¨‹</span></button>
                      
                      {activeTab === 'itinerary' && <button onClick={() => setIsAddActivityOpen(true)} className="btn-sakura text-white p-4 rounded-full shadow-lg shadow-rose-200 -mt-8 border-4 border-[#fffbf0] hover:scale-105 transition-transform"><Plus size={24} /></button>}
                      
                      <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1 ${activeTab === 'info' ? 'text-rose-600' : 'text-stone-400'}`}><Info size={24} strokeWidth={activeTab==='info'?2.5:2} /><span className="text-[10px] font-bold">è³‡è¨Š</span></button>
                  </nav>

                  {isAddActivityOpen && (
                      <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-end justify-center z-50 p-4" onClick={(e) => e.target === e.currentTarget && setIsAddActivityOpen(false)}>
                          <div className="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom duration-200">
                              <h3 className="text-xl font-bold mb-4 text-stone-800 japanese-font">æ–°å¢ Day {currentDayIndex + 1} è¡Œç¨‹</h3>
                              <div className="space-y-3">
                                  <div className="flex gap-3"><input type="time" value={newActivity.time} onChange={e=>setNewActivity({...newActivity, time:e.target.value})} className="bg-stone-50 p-3 rounded-xl border-none w-1/3 font-mono text-center font-bold text-lg outline-none" /><select value={newActivity.type} onChange={e=>setNewActivity({...newActivity, type:e.target.value})} className="bg-stone-50 p-3 rounded-xl border-none flex-1 font-bold text-stone-600 outline-none">{Object.entries(ACTIVITY_TYPES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select></div><input type="text" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: åƒåˆé¤)" value={newActivity.title} onChange={e=>setNewActivity({...newActivity, title:e.target.value})} className="w-full p-4 bg-stone-50 rounded-xl font-bold text-lg outline-none" autoFocus /><input type="text" placeholder="åœ°é»" value={newActivity.location} onChange={e=>setNewActivity({...newActivity, location:e.target.value})} className="w-full p-4 bg-stone-50 rounded-xl text-stone-600 outline-none" /><button onClick={handleAddManualActivity} className="w-full py-4 btn-sakura text-white rounded-xl font-bold text-lg shadow-lg">ç¢ºèªåŠ å…¥</button>
                              </div>
                          </div>
                      </div>
                  )}

                  {!isChatOpen && <button onClick={() => setIsChatOpen(true)} className="fixed bottom-24 right-6 w-12 h-12 bg-white text-indigo-600 border border-indigo-100 rounded-full shadow-lg flex items-center justify-center z-40 hover:scale-105 transition-transform"><Sparkles size={20} /></button>}
                  <AIChatSidebar isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} currentTrip={currentTrip} onUpdateTrip={handleUpdateTrip} />
                  
                  {isImportModalOpen && <MapImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImport={(days, title) => { const updatedTrips = trips.map(t => t.id === currentTripId ? { ...t, title, days: days.map((d, i) => ({ id: generateId(), date: d.dateTitle || `Day ${i + 1}`, hotel: t.days[i]?.hotel || "", activities: d.activities.map(act => ({ ...act, id: generateId() })) })) } : t); setTrips(updatedTrips); setCurrentDayIndex(0); }} currentTrip={currentTrip} />}
                  {activeMapLocation && <DraggableMapWindow location={activeMapLocation} onClose={() => setActiveMapLocation(null)} />}
              </div>
          );
        }

        // Re-inject MapImportModal for the closure above
        function MapImportModal({ isOpen, onClose, onImport, currentTrip }) {
            const [importText, setImportText] = useState("");
            const [selectedImage, setSelectedImage] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [parsedDays, setParsedDays] = useState([]); 
            const [importTitle, setImportTitle] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [currentStep, setCurrentStep] = useState(1); 
            const fileInputRef = useRef(null);
            useEffect(() => { if (isOpen) { setCurrentStep(1); setParsedDays([]); setImportText(""); setSelectedImage(null); setPreviewUrl(null); } }, [isOpen]);
            const handleImageChange = (e) => { const file = e.target.files[0]; if (file) { setSelectedImage(file); setPreviewUrl(URL.createObjectURL(file)); } };
            const fileToGenerativePart = async (file) => { const reader = new FileReader(); return new Promise((resolve) => { reader.onloadend = () => resolve({ inline_data: { data: reader.result.split(',')[1], mime_type: file.type } }); reader.readAsDataURL(file); }); };
            const handleExecute = async () => { if (!importText && !selectedImage) return; setIsLoading(true); setParsedDays([]); const hotel = currentTrip.days[0].hotel || "ä½å®¿åœ°é»"; try { let parts = [{ text: `æ‚¨æ˜¯å°ˆæ¥­å°éŠã€‚è«‹æ ¹æ“šä½¿ç”¨è€…çš„è¼¸å…¥ï¼ˆæ–‡å­—æˆ–åœ–ç‰‡ï¼‰ï¼Œè§£æå‡ºæ‰€æœ‰ã€Œåœ°é»åç¨±ã€ã€‚è«‹ä»¥ã€Œè‡ªé§•ã€ç‚ºå‰æï¼Œæ ¹æ“šä½å®¿åœ°é»ã€Œ${hotel}ã€ä½œç‚ºæ¯æ—¥èµ·é»ï¼Œå°‡é€™äº›åœ°é»åˆ†é…åˆ° ${currentTrip.days.length} å¤©çš„è¡Œç¨‹ä¸­ã€‚æ¯å€‹è¡Œç¨‹è«‹å‹™å¿…åŒ…å« "duration" (å»ºè­°åœç•™æ™‚é–“ï¼Œå¦‚ "2å°æ™‚")ã€‚è«‹å›å‚³ JSON: { "tripTitle": "...", "days": [{ "dateTitle": "...", "activities": [{ "time": "HH:MM", "title": "åœ°é»åç¨±", "type": "sightseeing/food/shopping", "location": "åœ°é»åç¨±(ç”¨æ–¼å°èˆª)", "note": "ç‰¹è‰²èˆ‡å»ºè­°", "duration": "..." }] }] }` }]; if (importText) parts.push({ text: importText }); if (selectedImage) parts.push(await fileToGenerativePart(selectedImage)); const result = await callGemini(parts); setParsedDays(result.days || []); setImportTitle(result.tripTitle || currentTrip.title); setCurrentStep(2); } catch (error) { alert("AI Error: " + error.message); } finally { setIsLoading(false); } };
            if (!isOpen) return null;
            return <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-end md:items-center justify-center z-50 p-0 md:p-4 overflow-y-auto"><div className="bg-white rounded-t-3xl md:rounded-3xl w-full max-w-lg p-6 pb-10 md:pb-6 shadow-2xl h-[85vh] md:h-auto flex flex-col animate-in slide-in-from-bottom duration-200"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-stone-800 flex items-center gap-2 japanese-font"><ListPlus size={24}/> {currentStep === 1 ? "æ™ºèƒ½åŒ¯å…¥" : "ç¢ºèªè¡Œç¨‹"}</h3><button onClick={onClose} className="p-2 text-stone-400 hover:bg-stone-100 rounded-full"><X size={20} /></button></div><div className="flex-1 overflow-y-auto custom-scrollbar">{currentStep === 1 ? (<div className="space-y-4"><div className="bg-stone-50 p-4 rounded-xl border border-stone-200 text-center"><input type="file" accept="image/*" ref={fileInputRef} onChange={handleImageChange} className="hidden" />{!previewUrl ? <div onClick={() => fileInputRef.current.click()} className="cursor-pointer py-6 flex flex-col items-center gap-2 text-stone-400"><ImagePlus size={48} className="text-stone-300"/><p>ä¸Šå‚³ Google Maps æˆªåœ–</p></div> : <div className="relative"><img src={previewUrl} className="max-h-48 mx-auto rounded-lg" /><button onClick={() => { setPreviewUrl(null); setSelectedImage(null); }} className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full"><X size={16}/></button></div>}</div><textarea placeholder="æˆ–è²¼ä¸Šæ–‡å­—..." value={importText} onChange={(e) => setImportText(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl h-24 text-sm"></textarea><button onClick={handleExecute} disabled={(!importText && !selectedImage) || isLoading} className="w-full py-4 btn-sakura text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 disabled:opacity-50">{isLoading ? <Loader2 className="animate-spin" /> : "AI æ™ºèƒ½åˆ†æèˆ‡è¦åŠƒ"}</button></div>) : (<div className="space-y-4"><div className="space-y-3">{parsedDays.map((day, idx) => (<div key={idx} className="border border-stone-200 rounded-xl p-4 bg-stone-50/50"><h4 className="font-bold text-stone-800 mb-2">{day.dateTitle || `Day ${idx+1}`}</h4><div className="space-y-2">{day.activities.map((a,i)=>(<div key={i} className="text-sm flex gap-2"><span className="text-rose-600 font-mono w-12 flex-shrink-0">{a.time}</span><span className="truncate">{a.title}</span></div>))}</div></div>))}</div><div className="flex gap-3 pt-2"><button onClick={() => setCurrentStep(1)} className="flex-1 py-3 bg-white border border-stone-300 text-stone-600 font-bold rounded-xl">é‡æ–°ç·¨è¼¯</button><button onClick={() => { onImport(parsedDays, importTitle); onClose(); }} className="flex-[2] py-3 btn-sakura text-white font-bold rounded-xl">ç¢ºèªåŒ¯å…¥</button></div></div>)}</div></div></div>;
        }

        function AIChatSidebar({ isOpen, onClose, currentTrip, onUpdateTrip }) {
            const [messages, setMessages] = useState([{ role: 'assistant', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ—…éŠåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¹«ä½ èª¿æ•´è¡Œç¨‹ã€æ¨è–¦é¤å»³ï¼Œæˆ–æ˜¯è§£ç­”æ—…éŠå•é¡Œã€‚' }]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);
            useEffect(() => { if (messagesEndRef.current) messagesEndRef.current.scrollIntoView({ behavior: "smooth" }); }, [messages]);
            const handleSend = async () => { if (!input.trim() || isLoading) return; const userText = input; setMessages(prev => [...prev, { role: 'user', text: userText }]); setInput(""); setIsLoading(true); try { const tripContext = currentTrip ? JSON.stringify({ title: currentTrip.title, days: currentTrip.days.map((d, i) => ({ index: i, date: d.date, activities: d.activities.map(a => ({ time: a.time, title: a.title, location: a.location })) })) }) : "No trip selected"; const prompt = `ä½ æ˜¯ä¸€å€‹æœ‰èƒ½åŠ›ä¿®æ”¹ JSON è³‡æ–™çš„æ—…éŠåŠ©æ‰‹ã€‚Current Trip Data: ${tripContext}. User Request: ${userText}. å¦‚æœæ˜¯æ™®é€šèŠå¤©ï¼Œå›å‚³ JSON: { "type": "chat", "response": "Markdown response" }. å¦‚æœæ˜¯ä¿®æ”¹è¡Œç¨‹ï¼Œå›å‚³ JSON: { "type": "update_day", "dayIndex": 0, "response": "Done", "newActivities": [ { "time": "HH:MM", "title": "...", "type": "...", "location": "...", "note": "...", "duration": "..." } ] }`; const result = await callGemini(prompt, "application/json"); if (result.type === 'update_day' && currentTrip) { const updatedDays = [...currentTrip.days]; if (updatedDays[result.dayIndex]) { updatedDays[result.dayIndex].activities = result.newActivities.map(a => ({...a, id: generateId()})); onUpdateTrip(currentTrip.id, { days: updatedDays }); setMessages(prev => [...prev, { role: 'assistant', text: result.response + " âœ…" }]); } else { setMessages(prev => [...prev, { role: 'assistant', text: "æ‰¾ä¸åˆ°è©²å¤©è¡Œç¨‹ã€‚" }]); } } else { setMessages(prev => [...prev, { role: 'assistant', text: result.response || "æ”¶åˆ°ï¼" }]); } } catch (error) { setMessages(prev => [...prev, { role: 'assistant', text: "API Error. è«‹ç¨å¾Œå†è©¦ã€‚" }]); } finally { setIsLoading(false); } };
            if (!isOpen) return null;
            return <div className="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 border-l border-stone-200"><div className="p-4 bg-gradient-to-r from-rose-50 to-orange-50 border-b border-stone-200 flex justify-between items-center flex-none"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gradient-to-tr from-rose-400 to-orange-400 flex items-center justify-center text-white"><Sparkles size={16}/></div><h3 className="font-bold text-stone-800 japanese-font">AI éš¨èº«åŠ©æ‰‹</h3></div><button onClick={onClose} className="p-2 hover:bg-white/50 rounded-full"><X size={20}/></button></div><div className="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50/50">{messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] rounded-2xl p-3 text-sm shadow-sm ${m.role === 'user' ? 'bg-rose-500 text-white rounded-tr-none' : 'bg-white border border-stone-100 text-stone-800 rounded-tl-none prose prose-sm'}`} dangerouslySetInnerHTML={{ __html: m.role === 'assistant' ? marked.parse(m.text) : m.text }}></div></div>))}{isLoading && <div className="flex justify-start"><div className="bg-white border border-stone-100 rounded-2xl p-3 rounded-tl-none flex items-center gap-2 text-stone-400 text-xs"><Loader2 className="animate-spin" size={12}/> æ€è€ƒè¡Œç¨‹ä¸­...</div></div>}<div ref={messagesEndRef} /></div><div className="p-3 border-t border-stone-200 bg-white flex-none pb-safe"><div className="flex gap-2"><input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder="è¼¸å…¥è¨Šæ¯..." className="flex-1 bg-stone-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-rose-500 outline-none" /><button onClick={handleSend} disabled={!input.trim() || isLoading} className="p-3 bg-rose-500 text-white rounded-xl hover:bg-rose-600 disabled:opacity-50"><Send size={18} /></button></div></div></div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TravelPlanner />);
    </script>
</body>
</html>


